<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>é–“ Ma Budget</title>
<link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;600;800&family=Zen+Kaku+Gothic+New:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

:root {
â€“bg: #ffffff;
â€“bg-warm: #fafafa;
â€“ink: #1a1a1a;
â€“ink-light: #555555;
â€“ink-faint: #aaaaaa;
â€“ink-ghost: #e0e0e0;
â€“shu: #c41e1e;        /* æœ± Vermillion ink */
â€“shu-light: #e8524a;
â€“shu-bg: #fff5f5;
â€“matcha: #3d6b35;     /* æŠ¹èŒ¶ */
â€“safe-bottom: env(safe-area-inset-bottom, 16px);
â€“safe-top: env(safe-area-inset-top, 0px);
}

html, body {
height: 100%; height: 100dvh;
font-family: â€˜Zen Kaku Gothic Newâ€™, sans-serif;
font-size: 14px; color: var(â€“ink);
background: var(â€“bg);
overflow: hidden;
overscroll-behavior: none;
-webkit-text-size-adjust: 100%;
}

#app {
display: flex; flex-direction: column;
height: 100dvh; height: 100%;
position: relative; overflow: hidden;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
HEADER â€” Goshuin style
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#header {
padding: calc(var(â€“safe-top) + 10px) 20px 12px;
background: var(â€“bg);
flex-shrink: 0;
position: relative;
}

.header-top {
display: flex; align-items: center; justify-content: space-between;
margin-bottom: 14px;
}

.brand {
display: flex; align-items: center; gap: 12px;
}

/* Hanko seal â€” like a real goshuin stamp */
.hanko-seal {
width: 36px; height: 36px;
border: 2px solid var(â€“shu);
display: flex; align-items: center; justify-content: center;
position: relative;
transform: rotate(-2deg);
flex-shrink: 0;
}
.hanko-seal::before {
content: â€˜â€™;
position: absolute; inset: 3px;
border: 1px solid var(â€“shu);
opacity: 0.5;
}
.hanko-kanji {
font-family: â€˜Shippori Minchoâ€™, serif;
font-size: 16px; font-weight: 800;
color: var(â€“shu);
line-height: 1;
}

.brand-text { display: flex; flex-direction: column; gap: 1px; }
.brand-title {
font-family: â€˜Shippori Minchoâ€™, serif;
font-size: 15px; font-weight: 800;
color: var(â€“ink);
letter-spacing: 1px;
}
.brand-sub {
font-size: 7px; letter-spacing: 3px;
color: var(â€“ink-faint); text-transform: uppercase;
}

/* Month navigator */
.month-nav {
display: flex; align-items: center; gap: 10px;
}
.month-btn {
background: none; border: none;
color: var(â€“ink-faint); font-size: 12px;
cursor: pointer; padding: 6px;
transition: color 0.2s;
}
.month-btn:active { color: var(â€“ink); }

#month-lbl {
font-family: â€˜Shippori Minchoâ€™, serif;
font-size: 14px; font-weight: 600;
text-transform: capitalize;
color: var(â€“ink);
min-width: 110px; text-align: center;
}

/* Summary pills */
#pills {
display: flex; gap: 0;
border-top: 1px solid var(â€“ink-ghost);
border-bottom: 1px solid var(â€“ink-ghost);
}
.pill {
flex: 1; padding: 8px 8px;
text-align: center; position: relative;
}
.pill + .pill::before {
content: â€˜â€™; position: absolute; left: 0; top: 25%; bottom: 25%;
width: 1px; background: var(â€“ink-ghost);
}
.pill-lbl {
font-size: 7px; text-transform: uppercase;
color: var(â€“ink-faint); letter-spacing: 1.5px;
margin-bottom: 2px; display: block;
}
.pill-val {
font-family: â€˜Shippori Minchoâ€™, serif;
font-size: 12px; font-weight: 600;
color: var(â€“ink); display: block;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
BANNER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#banner {
padding: 14px 20px;
background: var(â€“bg);
display: flex; align-items: center; justify-content: space-between;
flex-shrink: 0; cursor: pointer;
transition: all 0.3s ease;
border-bottom: 1px solid var(â€“ink-ghost);
position: relative;
}
#banner:active { background: var(â€“bg-warm); }
#banner.deficit-bg { background: var(â€“shu-bg); }

.banner-left { display: flex; flex-direction: column; gap: 1px; }
.banner-label {
font-size: 8px; letter-spacing: 2px; text-transform: uppercase;
color: var(â€“ink-faint);
}

#to-assign {
font-family: â€˜Shippori Minchoâ€™, serif;
font-size: 26px; font-weight: 800;
color: var(â€“ink); transition: color 0.3s;
line-height: 1.2;
}
#to-assign.deficit { color: var(â€“shu); }
#to-assign.balanced { color: var(â€“matcha); }

.pulse-text { animation: pulse 2.5s ease-in-out infinite; }
@keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.4; } }

.age-box { text-align: right; }
#age-num {
font-family: â€˜Shippori Minchoâ€™, serif;
font-size: 22px; font-weight: 400;
color: var(â€“ink-light); line-height: 1;
}
.age-lbl {
font-size: 7px; letter-spacing: 1.5px;
color: var(â€“ink-faint); text-transform: uppercase;
margin-top: 2px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SCROLL & PANELS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#scroll {
flex: 1; overflow-y: auto;
padding-bottom: 75px;
-webkit-overflow-scrolling: touch;
}
.panel { display: none; animation: fadeSlide 0.3s ease; }
.panel.on { display: block; }
@keyframes fadeSlide { from { opacity:0; transform:translateY(6px); } to { opacity:1; transform:translateY(0); } }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
BUDGET TABLE â€” Sumi ledger
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.g-row {
padding: 18px 20px 7px;
font-size: 9px; letter-spacing: 3px;
text-transform: uppercase;
color: var(â€“ink-faint);
display: flex; justify-content: space-between; align-items: center;
position: relative;
}
/* Ink brush stroke underline */
.g-row::after {
content: â€˜â€™;
position: absolute; bottom: 0; left: 20px; right: 20px;
height: 2px;
background: var(â€“ink);
opacity: 0.12;
}

.g-name-wrap { display: flex; align-items: center; gap: 8px; }
.g-add-btn {
background: none; border: none;
color: var(â€“ink-faint); font-size: 14px;
width: 22px; height: 22px;
display: flex; align-items: center; justify-content: center;
cursor: pointer; transition: color 0.2s;
}
.g-add-btn:active { color: var(â€“shu); }

.c-row {
display: grid;
grid-template-columns: 1fr 72px 72px;
padding: 14px 20px;
align-items: center;
border-bottom: 1px solid rgba(0,0,0,0.03);
}
.c-row:active { background: rgba(0,0,0,0.01); }

.c-name {
font-size: 14px; font-weight: 400;
color: var(â€“ink); cursor: pointer;
display: flex; align-items: center; gap: 8px;
}
.c-name:active { opacity: 0.5; }

.c-assigned { text-align: right; }
.c-assigned .val-txt {
font-family: â€˜Shippori Minchoâ€™, serif;
font-size: 12px; color: var(â€“ink-faint);
}

.c-avail {
font-family: â€˜Shippori Minchoâ€™, serif;
font-size: 13px; font-weight: 800; text-align: right;
}
.c-avail.pos { color: var(â€“ink); }
.c-avail.neg { color: var(â€“shu); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
TRANSACTIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tx-item {
display: flex; justify-content: space-between; align-items: center;
padding: 14px 20px;
border-bottom: 1px solid rgba(0,0,0,0.03);
}
.tx-info { display: flex; flex-direction: column; gap: 2px; }
.tx-payee { font-size: 14px; font-weight: 500; }
.tx-meta { font-size: 9px; color: var(â€“ink-faint); letter-spacing: 0.5px; }
.tx-amt-box { display: flex; align-items: center; gap: 12px; }
.tx-amt { font-family: â€˜Shippori Minchoâ€™, serif; font-size: 15px; font-weight: 800; }
.tx-amt.inc { color: var(â€“matcha); }
.tx-amt.exp { color: var(â€“shu); }
.tx-del { background: none; border: none; color: var(â€“ink-ghost); font-size: 16px; cursor: pointer; padding: 4px; }
.tx-del:active { color: var(â€“shu); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
GOALS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.goal-card {
margin-bottom: 16px; padding: 16px;
background: var(â€“bg);
border: 1px solid rgba(0,0,0,0.05);
position: relative;
}

.goal-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
.goal-title { font-size: 14px; font-weight: 500; display: flex; flex-direction: column; gap: 3px; }
.goal-link-badge { font-size: 8px; color: var(â€“ink-faint); letter-spacing: 1px; }
.goal-amounts { font-family: â€˜Shippori Minchoâ€™, serif; font-size: 12px; text-align: right; }

.goal-bar-bg {
height: 2px; background: var(â€“ink-ghost);
width: 100%; position: relative; margin-bottom: 12px;
overflow: visible;
}
.goal-bar-fill {
height: 100%; position: absolute; left: 0; top: 0;
transition: width 0.6s cubic-bezier(0.4,0,0.2,1);
}
.goal-bar-fill.complete { background: var(â€“shu); }
.goal-bar-fill.progress { background: var(â€“ink); }

/* Small circle marker at fill end */
.goal-bar-fill::after {
content: â€˜â€™;
position: absolute; right: -3px; top: -2px;
width: 6px; height: 6px;
border-radius: 50%;
background: inherit;
}

.goal-actions { display: flex; justify-content: space-between; align-items: center; }
.goal-pct { font-size: 9px; color: var(â€“ink-faint); letter-spacing: 1.5px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
STATS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.stat-row { margin-bottom: 16px; }
.stat-header { display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 5px; }
.stat-name { font-weight: 500; }
.stat-val { font-family: â€˜Shippori Minchoâ€™, serif; color: var(â€“ink-light); }
.stat-bar-bg { height: 2px; background: var(â€“ink-ghost); width: 100%; position: relative; }
.stat-bar-fill { height: 100%; background: var(â€“ink); position: absolute; left: 0; top: 0; transition: width 0.5s ease; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
NAVIGATION â€” Ink bar
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#nav {
background: var(â€“ink);
display: flex;
padding-bottom: var(â€“safe-bottom);
z-index: 50;
flex-shrink: 0;
width: 100%;
min-height: 54px;
}

.ntab {
flex: 1; padding: 9px 0 7px;
background: none; border: none;
color: rgba(255,255,255,0.25);
display: flex; flex-direction: column; align-items: center; gap: 2px;
transition: color 0.3s; cursor: pointer;
position: relative;
}
.ntab.on { color: #ffffff; }
/* Shu red indicator dot for active tab */
.ntab.on::before {
content: â€˜â€™;
position: absolute; top: 4px; left: 50%;
transform: translateX(-50%);
width: 4px; height: 4px;
border-radius: 50%;
background: var(â€“shu);
}

.nicon {
font-family: â€˜Shippori Minchoâ€™, serif;
font-size: 15px; font-weight: 800;
}
.nlbl { font-size: 7px; letter-spacing: 1.5px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
FAB â€” Hanko stamp button
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#fab {
position: fixed; right: 20px; bottom: calc(68px + var(â€“safe-bottom));
width: 48px; height: 48px;
background: var(â€“shu);
display: flex; align-items: center; justify-content: center;
color: #fff; font-size: 22px; font-weight: 300;
border: none; cursor: pointer; z-index: 40;
box-shadow: 0 2px 12px rgba(196,30,30,0.3);
transition: all 0.15s;
border-radius: 0;
transform: rotate(-1deg);
}
#fab:active {
transform: rotate(0deg) scale(0.92);
box-shadow: 0 1px 6px rgba(196,30,30,0.3);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
MODALS â€” Clean sheet
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.overlay {
position: fixed; top: 0; left: 0; right: 0; bottom: 0;
background: rgba(0,0,0,0.35);
z-index: 100;
opacity: 0; pointer-events: none;
transition: opacity 0.3s ease;
backdrop-filter: blur(3px);
-webkit-backdrop-filter: blur(3px);
}
.overlay.open { opacity: 1; pointer-events: auto; }

.sheet {
position: absolute; bottom: 0; left: 0; right: 0;
background: var(â€“bg);
padding: 24px 20px calc(24px + var(â€“safe-bottom));
transform: translateY(100%);
transition: transform 0.4s cubic-bezier(0.16,1,0.3,1);
max-height: 90vh; overflow-y: auto;
}
/* Ink stroke top border */
.sheet::before {
content: â€˜â€™;
position: absolute; top: 0; left: 0; right: 0;
height: 2px; background: var(â€“ink);
}
.overlay.open .sheet { transform: translateY(0); }

.sheet-header {
display: flex; justify-content: space-between; align-items: center;
margin-bottom: 22px;
}
.sh-title {
font-family: â€˜Shippori Minchoâ€™, serif;
font-size: 18px; font-weight: 800; color: var(â€“ink);
}
.sh-close {
background: none; border: none;
font-size: 18px; color: var(â€“ink-faint);
cursor: pointer; padding: 4px;
}
.sh-close:active { color: var(â€“ink); }

/* Buttons */
.sbtn {
background: var(â€“ink); color: #fff;
text-transform: uppercase; letter-spacing: 2px;
font-size: 10px; font-weight: 700;
border: none; cursor: pointer;
font-family: â€˜Zen Kaku Gothic Newâ€™, sans-serif;
border-radius: 0; transition: opacity 0.15s;
}
.sbtn:active { opacity: 0.8; }

.sbtn-shu {
background: var(â€“shu); color: #fff;
text-transform: uppercase; letter-spacing: 2px;
font-size: 10px; font-weight: 700;
border: none; cursor: pointer;
font-family: â€˜Zen Kaku Gothic Newâ€™, sans-serif;
border-radius: 0;
}
.sbtn-shu:active { opacity: 0.85; }

.sbtn-outline {
border: 1px solid var(â€“ink-ghost); background: transparent;
color: var(â€“ink); text-transform: uppercase;
letter-spacing: 1px; font-size: 9px;
padding: 7px 12px; cursor: pointer; font-weight: 700;
font-family: â€˜Zen Kaku Gothic Newâ€™, sans-serif;
transition: all 0.15s;
}
.sbtn-outline:active { background: var(â€“bg-warm); }

.sbtn-dashed {
border: 1px dashed var(â€“ink-ghost); background: transparent;
color: var(â€“ink-faint); text-transform: uppercase;
letter-spacing: 2px; font-size: 9px;
padding: 14px; cursor: pointer; font-weight: 500;
width: 100%; font-family: â€˜Zen Kaku Gothic Newâ€™, sans-serif;
transition: all 0.2s;
}
.sbtn-dashed:active { border-color: var(â€“ink); color: var(â€“ink); }

/* Inputs */
.finp {
width: 100%; padding: 10px 0; border: none;
border-bottom: 1px solid var(â€“ink-ghost);
font-family: â€˜Zen Kaku Gothic Newâ€™, sans-serif;
font-size: 15px; outline: none;
transition: border-color 0.3s;
background: transparent; border-radius: 0;
color: var(â€“ink);
}
.finp:focus { border-bottom-color: var(â€“ink); }
.finp::placeholder { color: #ccc; }

/* Type toggle */
.type-toggle { display: flex; border: 1px solid var(â€“ink-ghost); }
.type-btn {
flex: 1; padding: 10px;
font-size: 10px; font-weight: 700;
text-transform: uppercase; letter-spacing: 1.5px;
border: none; cursor: pointer;
font-family: â€˜Zen Kaku Gothic Newâ€™, sans-serif;
transition: all 0.2s;
}
.type-btn.active { background: var(â€“ink); color: #fff; }
.type-btn.inactive { background: transparent; color: var(â€“ink-faint); }

/* Section title with shu underline */
.section-title {
font-family: â€˜Shippori Minchoâ€™, serif;
font-size: 18px; font-weight: 800;
color: var(â€“ink);
position: relative; display: inline-block;
padding-bottom: 6px;
}
.section-title::after {
content: â€˜â€™;
position: absolute; bottom: 0; left: 0;
width: 20px; height: 2px;
background: var(â€“shu);
}

/* Empty states with decorative SVG */
.empty-state {
padding: 40px 20px; text-align: center;
color: var(â€“ink-faint); font-size: 10px;
letter-spacing: 1.5px; line-height: 2.2;
}

/* Inline SVG illustrations */
.sumi-art {
display: block; margin: 0 auto 12px;
opacity: 0.06;
}

/* Settings */
.setting-block { margin-bottom: 24px; }
.setting-title {
font-size: 8px; font-weight: 700;
margin-bottom: 12px; color: var(â€“ink);
text-transform: uppercase; letter-spacing: 2.5px;
}

/* Toast */
#toast {
position: fixed; top: calc(var(â€“safe-top) + 10px);
left: 50%; transform: translateX(-50%) translateY(-30px);
background: var(â€“ink); color: #fff;
padding: 9px 22px;
font-size: 9px; letter-spacing: 2px; text-transform: uppercase;
z-index: 2000; opacity: 0; pointer-events: none;
transition: all 0.35s cubic-bezier(0.16,1,0.3,1);
font-family: â€˜Zen Kaku Gothic Newâ€™, sans-serif; font-weight: 500;
}
#toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
</style>

</head>
<body>

<div id="app">
  <header id="header">
    <div class="header-top">
      <div class="brand">
        <div class="hanko-seal"><span class="hanko-kanji">é–“</span></div>
        <div class="brand-text">
          <span class="brand-title">Ma Budget</span>
          <span class="brand-sub">Ingresos Â· Gastos</span>
        </div>
      </div>
      <div class="month-nav">
        <button class="month-btn" onclick="changeMonth(-1)">â—‚</button>
        <div id="month-lbl">Mes</div>
        <button class="month-btn" onclick="changeMonth(1)">â–¸</button>
      </div>
    </div>
    <div id="pills">
      <div class="pill"><span class="pill-lbl">Entradas</span><span class="pill-val" id="p-income">0</span></div>
      <div class="pill"><span class="pill-lbl">Asignado</span><span class="pill-val" id="p-assigned">0</span></div>
      <div class="pill"><span class="pill-lbl">Gastos</span><span class="pill-val" id="p-spent">0</span></div>
    </div>
  </header>

  <div id="banner" onclick="openSheet('budget-opts')">
    <div class="banner-left">
      <div class="banner-label">Presupuesto Disponible</div>
      <div id="to-assign">0,00 â‚¬</div>
    </div>
    <div class="age-box">
      <div id="age-num">0</div>
      <div class="age-lbl">DÃ­as de Vida</div>
    </div>
  </div>

  <div id="scroll">
    <div class="panel on" id="panel-budget"><div id="budget-content"></div></div>
    <div class="panel" id="panel-tx"><div id="tx-content"></div></div>
    <div class="panel" id="panel-goals"><div id="goals-content" style="padding:22px 20px;"></div></div>
    <div class="panel" id="panel-rep"><div id="rep-content" style="padding:22px 20px;"></div></div>
    <div class="panel" id="panel-settings">
      <div style="padding:22px 20px;">
        <div class="section-title" style="margin-bottom:24px;">Ajustes</div>
        <div class="setting-block">
          <div class="setting-title">Copias de Seguridad</div>
          <p style="font-size:11px; color:var(--ink-faint); margin-bottom:12px; line-height:1.5;">
            Guarda tu progreso o restaura una copia anterior.
          </p>
          <div style="display:flex; gap:8px;">
            <button class="sbtn-outline" style="flex:1; padding:13px;" onclick="exportData()">â¬‡ Exportar</button>
            <button class="sbtn-outline" style="flex:1; padding:13px;" onclick="document.getElementById('import-file').click()">â¬† Importar</button>
            <input type="file" id="import-file" style="display:none;" accept=".json" onchange="importData(event)">
          </div>
        </div>
        <div style="border-top: 1px dashed var(--ink-ghost); margin: 24px 0;"></div>
        <div class="setting-block">
          <div class="setting-title" style="color:var(--shu);">Zona de Peligro</div>
          <button class="sbtn-shu" style="width:100%; padding:14px;" onclick="resetApp()">Reiniciar Todo</button>
        </div>
      </div>
    </div>
  </div>

<button id="fab" onclick="openSheet('tx')">ï¼‹</button>

  <nav id="nav">
    <button class="ntab on" id="tab-budget" onclick="showPanel('budget')"><span class="nicon">ä½“</span><span class="nlbl">Plan</span></button>
    <button class="ntab" id="tab-tx" onclick="showPanel('tx')"><span class="nicon">éŒ²</span><span class="nlbl">Movs</span></button>
    <button class="ntab" id="tab-goals" onclick="showPanel('goals')"><span class="nicon">çš„</span><span class="nlbl">Metas</span></button>
    <button class="ntab" id="tab-rep" onclick="showPanel('rep')"><span class="nicon">å›³</span><span class="nlbl">Stats</span></button>
    <button class="ntab" id="tab-settings" onclick="showPanel('settings')"><span class="nicon">è¨­</span><span class="nlbl">Ajustes</span></button>
  </nav>
</div>

<!-- â•â•â•â•â•â• MODALS â•â•â•â•â•â• -->

<div class="overlay" id="ov-budget-opts" onclick="closeSheet(event)">
  <div class="sheet" onclick="event.stopPropagation()">
    <div class="sheet-header">
      <div class="sh-title">AsignaciÃ³n RÃ¡pida</div>
      <button class="sh-close" onclick="closeSheet()">âœ•</button>
    </div>
    <p style="font-size:10px; color:var(--ink-faint); margin-bottom:14px; line-height:1.5;">
      Mueve dinero a una categorÃ­a. Usa valor negativo para retirar.
    </p>
    <select id="f-quick-cat" class="finp" style="margin-bottom:10px;"></select>
    <input type="number" id="f-quick-amt" class="finp" placeholder="Importe" style="margin-bottom:18px; font-size:24px; font-family:'Shippori Mincho',serif; font-weight:800;" step="0.01">
    <button class="sbtn" style="width:100%; padding:14px;" onclick="quickAssign()">Asignar</button>
  </div>
</div>

<div class="overlay" id="ov-new-group" onclick="closeSheet(event)">
  <div class="sheet" onclick="event.stopPropagation()">
    <div class="sheet-header"><div class="sh-title">Nuevo Grupo</div><button class="sh-close" onclick="closeSheet()">âœ•</button></div>
    <input type="text" id="ng-name" class="finp" placeholder="Nombre (ej. Suscripciones)" style="margin-bottom:22px">
    <button class="sbtn" style="width:100%; padding:14px;" onclick="saveGroup()">Crear</button>
  </div>
</div>

<div class="overlay" id="ov-new-cat" onclick="closeSheet(event)">
  <div class="sheet" onclick="event.stopPropagation()">
    <div class="sheet-header"><div class="sh-title">Nueva CategorÃ­a</div><button class="sh-close" onclick="closeSheet()">âœ•</button></div>
    <div style="display:flex; gap:10px; margin-bottom:22px;">
      <input type="text" id="nc-emoji" class="finp" placeholder="ğŸ“" style="width:50px; text-align:center;" maxlength="2">
      <input type="text" id="nc-name" class="finp" placeholder="Nombre" style="flex:1;">
    </div>
    <button class="sbtn" style="width:100%; padding:14px;" onclick="saveNewCategory()">AÃ±adir</button>
  </div>
</div>

<div class="overlay" id="ov-edit-cat" onclick="closeSheet(event)">
  <div class="sheet" onclick="event.stopPropagation()">
    <div class="sheet-header"><div class="sh-title">Editar CategorÃ­a</div><button class="sh-close" onclick="closeSheet()">âœ•</button></div>
    <div style="display:flex; gap:10px; margin-bottom:22px;">
      <input type="text" id="e-cat-emoji" class="finp" placeholder="ğŸœ" style="width:50px; text-align:center;" maxlength="2">
      <input type="text" id="e-cat-name" class="finp" placeholder="Nombre" style="flex:1;">
    </div>
    <div style="display:flex; gap:8px;">
      <button class="sbtn-outline" style="flex:1; padding:13px; border-color:var(--shu); color:var(--shu);" onclick="deleteCategory()">Eliminar</button>
      <button class="sbtn" style="flex:2; padding:13px;" onclick="saveEditCategory()">Guardar</button>
    </div>
  </div>
</div>

<div class="overlay" id="ov-tx" onclick="closeSheet(event)">
  <div class="sheet" onclick="event.stopPropagation()">
    <div class="sheet-header"><div class="sh-title">Nuevo Registro</div><button class="sh-close" onclick="closeSheet()">âœ•</button></div>
    <div class="type-toggle" style="margin-bottom:18px;">
      <button id="type-exp" class="type-btn active" onclick="setTxType('expense')">Gasto</button>
      <button id="type-inc" class="type-btn inactive" onclick="setTxType('income')">Ingreso</button>
    </div>
    <input type="number" id="f-amt" class="finp" placeholder="Importe" style="font-size:30px; font-weight:800; margin-bottom:10px; font-family:'Shippori Mincho',serif;" step="0.01">
    <input type="text" id="f-payee" class="finp" placeholder="Concepto (Opcional)" style="margin-bottom:10px">
    <input type="date" id="f-date" class="finp" style="margin-bottom:10px">
    <select id="f-cat" class="finp" style="margin-bottom:22px"></select>
    <button class="sbtn" style="width:100%; padding:14px;" onclick="saveTx()">Confirmar</button>
  </div>
</div>

<div class="overlay" id="ov-new-goal" onclick="closeSheet(event)">
  <div class="sheet" onclick="event.stopPropagation()">
    <div class="sheet-header"><div class="sh-title">Crear Meta</div><button class="sh-close" onclick="closeSheet()">âœ•</button></div>
    <input type="text" id="g-name" class="finp" placeholder="Nombre (ej. Viaje a JapÃ³n)" style="margin-bottom:10px">
    <input type="number" id="g-target" class="finp" placeholder="Objetivo" style="margin-bottom:10px" step="0.01">
    <div style="display:flex; gap:10px; margin-bottom:10px;">
      <input type="text" id="g-icon" class="finp" placeholder="â›©ï¸" style="width:50px; text-align:center;" maxlength="2">
      <select id="g-cat" class="finp" style="flex:1;"></select>
    </div>
    <p style="font-size:9px; color:var(--ink-faint); margin-bottom:22px; line-height:1.5;">
      Si vinculas una categorÃ­a, el progreso serÃ¡ su saldo disponible.
    </p>
    <button class="sbtn" style="width:100%; padding:14px;" onclick="saveGoal()">Crear</button>
  </div>
</div>

<div class="overlay" id="ov-fund-goal" onclick="closeSheet(event)">
  <div class="sheet" onclick="event.stopPropagation()">
    <div class="sheet-header"><div class="sh-title" id="fund-title">Aportar</div><button class="sh-close" onclick="closeSheet()">âœ•</button></div>
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
      <p style="font-size:10px; color:var(--ink-faint); margin:0;">Mover de "Disponible":</p>
      <button class="sbtn-outline" style="font-size:8px; padding:4px 8px;" onclick="fundAllAvailable()">Max</button>
    </div>
    <input type="number" id="f-goal-amt" class="finp" placeholder="Importe" style="font-size:30px; font-weight:800; margin-bottom:22px; font-family:'Shippori Mincho',serif;" step="0.01">
    <button class="sbtn" style="width:100%; padding:14px;" onclick="saveFunding()">Aportar</button>
  </div>
</div>

<div id="toast"></div>

<script>
let DB={groups:[],txs:[],assignments:{},goals:[],goalFundings:[],settings:{currency:'EUR',startDate:null}};
let currentMonth=new Date(),currentTxType='expense',activeGoalId=null,activeEditCat={gId:null,cId:null},activeTargetGroup=null;

function init(){
  const s=localStorage.getItem('ma_budget_pro_v1');
  if(s){DB=JSON.parse(s);if(!DB.goals)DB.goals=[];if(!DB.goalFundings)DB.goalFundings=[];if(!DB.settings)DB.settings={currency:'EUR',startDate:new Date().toISOString()};}
  else{
    DB.groups=[
      {id:'g1',name:'Esenciales',cats:[{id:'c1',name:'Vivienda',emoji:'ğŸ '},{id:'c2',name:'AlimentaciÃ³n',emoji:'ğŸ±'},{id:'c3',name:'Transporte',emoji:'ğŸšƒ'}]},
      {id:'g2',name:'Estilo de Vida',cats:[{id:'c4',name:'Ocio',emoji:'ğŸ¬'},{id:'c5',name:'Compras',emoji:'ğŸ›ï¸'}]}
    ];
    DB.goals=[{id:'goal_1',name:'Fondo de Emergencia',target:1000,icon:'ğŸ›¡ï¸',catId:null}];
    DB.goalFundings=[];DB.settings.startDate=new Date().toISOString();
  }
  DB.settings.currency='EUR';
  document.getElementById('f-date').valueAsDate=new Date();
  updateUI();
}

function updateUI(){
  document.getElementById('month-lbl').innerText=currentMonth.toLocaleDateString('es-ES',{month:'long'})+' '+currentMonth.getFullYear();
  document.getElementById('age-num').innerText=calculateAgeOfMoney();
  const ta=getToAssign(currentMonth),el=document.getElementById('to-assign'),b=document.getElementById('banner');
  el.innerText=formatMoney(ta);
  if(ta<-0.01){el.className='deficit pulse-text';b.classList.add('deficit-bg');}
  else if(Math.abs(ta)<=0.01){el.className='balanced';b.classList.remove('deficit-bg');}
  else{el.className='';b.classList.remove('deficit-bg');}
  renderBudget();renderTxs();renderGoals();renderStats();updatePills();save();
}

function calculateAgeOfMoney(){
  const ts=DB.txs.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amt,0);
  const inc=DB.txs.filter(t=>t.type==='income').sort((a,b)=>new Date(a.date)-new Date(b.date));
  if(!inc.length)return 0;
  let ri=0,cd=null;
  for(let i of inc){ri+=i.amt;if(ri>ts){cd=new Date(i.date);break;}}
  if(!cd)return 0;
  const today=new Date();if(today<cd)return 0;
  return Math.floor(Math.abs(today-cd)/(1000*60*60*24));
}

/* â”€â”€ Bamboo SVG for empty states â”€â”€ */
const BAMBOO_SVG=`<svg class="sumi-art" width="60" height="80" viewBox="0 0 60 80" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M30 5 L30 75" stroke="#1a1a1a" stroke-width="3" stroke-linecap="round"/>
<path d="M30 20 L30 22" stroke="#1a1a1a" stroke-width="5" stroke-linecap="round"/>
<path d="M30 40 L30 42" stroke="#1a1a1a" stroke-width="5" stroke-linecap="round"/>
<path d="M30 60 L30 62" stroke="#1a1a1a" stroke-width="5" stroke-linecap="round"/>
<path d="M30 18 Q40 10 50 8" stroke="#1a1a1a" stroke-width="1.5" fill="none" stroke-linecap="round"/>
<path d="M50 8 Q55 6 58 3" stroke="#1a1a1a" stroke-width="1" fill="none" stroke-linecap="round"/>
<path d="M30 18 Q42 14 52 15" stroke="#1a1a1a" stroke-width="1.5" fill="none" stroke-linecap="round"/>
<path d="M30 38 Q20 30 10 28" stroke="#1a1a1a" stroke-width="1.5" fill="none" stroke-linecap="round"/>
<path d="M10 28 Q5 26 2 23" stroke="#1a1a1a" stroke-width="1" fill="none" stroke-linecap="round"/>
<path d="M30 38 Q18 34 8 35" stroke="#1a1a1a" stroke-width="1.5" fill="none" stroke-linecap="round"/>
<path d="M30 58 Q40 50 48 48" stroke="#1a1a1a" stroke-width="1.5" fill="none" stroke-linecap="round"/>
</svg>`;

/* â”€â”€ Enso circle SVG â”€â”€ */
const ENSO_SVG=`<svg class="sumi-art" width="70" height="70" viewBox="0 0 70 70" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M35 8 C55 8 62 22 62 35 C62 48 55 62 35 62 C15 62 8 48 8 35 C8 22 15 10 30 8" stroke="#1a1a1a" stroke-width="3" stroke-linecap="round" fill="none"/>
</svg>`;

function renderBudget(){
  const mKey=getMonthKey(currentMonth),c=document.getElementById('budget-content');
  c.innerHTML='';if(!DB.assignments[mKey])DB.assignments[mKey]={};
  DB.groups.forEach(g=>{
    const d=document.createElement('div');
    const cats=g.cats.length===0
      ?`<div style="padding:14px 20px;font-size:10px;color:var(--ink-faint);text-align:center;">Grupo vacÃ­o</div>`
      :g.cats.map(cat=>{
        const a=DB.assignments[mKey][cat.id]||0,av=getAvailable(cat.id,currentMonth);
        return `<div class="c-row"><div class="c-name" onclick="openEditCat('${g.id}','${cat.id}')"><span>${cat.emoji||'ğŸ“'}</span><span>${cat.name}</span></div><div class="c-assigned"><span class="val-txt">${formatMoney(a)}</span></div><div class="c-avail ${av>=0?'pos':'neg'}">${formatMoney(av)}</div></div>`;
      }).join('');
    d.innerHTML=`<div class="g-row"><span class="g-name-wrap">${g.name}<button class="g-add-btn" onclick="openNewCatSheet('${g.id}')">+</button></span><span style="font-size:8px;">Asig. / Disp.</span></div>${cats}`;
    c.appendChild(d);
  });
  const ad=document.createElement('div');ad.style.padding='14px 20px';
  ad.innerHTML=`<button class="sbtn-dashed" onclick="openSheet('new-group')">+ Crear Nuevo Grupo</button>`;
  c.appendChild(ad);
}

function renderGoals(){
  const c=document.getElementById('goals-content');
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:22px;"><div class="section-title">Metas</div><button onclick="openSheet('new-goal')" class="sbtn-outline">+ Nueva</button></div>`;
  if(!DB.goals||!DB.goals.length){
    h+=`<div class="empty-state">${ENSO_SVG}AÃºn no has trazado ningÃºn camino.<br>Crea tu primera meta.</div>`;
  }else{
    DB.goals.forEach(g=>{
      let f=0,ln=null;
      if(g.catId){f=Math.max(0,getAvailable(g.catId,currentMonth));ln=getCatName(g.catId);}
      else{f=(DB.goalFundings||[]).filter(x=>x.goalId===g.id).reduce((s,x)=>s+x.amt,0);}
      const p=g.target>0?Math.min(100,(f/g.target)*100).toFixed(1):0,ic=f>=g.target;
      h+=`<div class="goal-card"><div class="goal-header"><div class="goal-title"><div>${g.icon||'ğŸ¯'} ${g.name}</div>${ln?`<div class="goal-link-badge">ğŸ”— ${ln}</div>`:''}</div><div class="goal-amounts"><span style="font-weight:800;color:${ic?'var(--shu)':'var(--ink)'}">${formatMoney(f)}</span><span style="color:var(--ink-faint);font-size:11px"> / ${formatMoney(g.target)}</span></div></div><div class="goal-bar-bg"><div class="goal-bar-fill ${ic?'complete':'progress'}" style="width:${p}%"></div></div><div class="goal-actions"><span class="goal-pct">${p}%</span><div style="display:flex;gap:8px;"><button class="sbtn-outline" style="padding:4px 8px;color:var(--ink-faint);border-color:var(--ink-ghost);" onclick="deleteGoal('${g.id}')">âœ•</button><button class="sbtn" style="padding:5px 12px;font-size:9px;" onclick="openFundSheet('${g.id}',this)" data-name="${g.name.replace(/"/g,'&quot;').replace(/'/g,'&#39;')}">Aportar</button></div></div></div>`;
    });
  }
  c.innerHTML=h;
}

function renderTxs(){
  const mKey=getMonthKey(currentMonth),c=document.getElementById('tx-content');
  const txs=DB.txs.filter(t=>t.date.startsWith(mKey)).sort((a,b)=>b.date.localeCompare(a.date)||b.id.localeCompare(a.id));
  if(!txs.length){c.innerHTML=`<div class="empty-state">${BAMBOO_SVG}No hay movimientos este mes.</div>`;return;}
  c.innerHTML=txs.map(t=>{
    const isI=t.type==='income',cn=isI?'Ingreso':getCatName(t.cat),sg=isI?'+':'-';
    return `<div class="tx-item"><div class="tx-info"><span class="tx-payee">${t.payee||'Sin concepto'}</span><span class="tx-meta">${t.date} Â· ${cn}</span></div><div class="tx-amt-box"><span class="tx-amt ${isI?'inc':'exp'}">${sg}${formatMoney(Math.abs(t.amt))}</span><button class="tx-del" onclick="deleteTx('${t.id}')">âœ•</button></div></div>`;
  }).join('');
}

function renderStats(){
  const mKey=getMonthKey(currentMonth),c=document.getElementById('rep-content');
  const exps=DB.txs.filter(t=>t.type==='expense'&&t.date.startsWith(mKey));
  const tot=exps.reduce((a,t)=>a+t.amt,0);let bc={};
  exps.forEach(t=>{bc[t.cat]=(bc[t.cat]||0)+t.amt;});
  let h=`<div class="section-title" style="margin-bottom:22px;">Flujo del Mes</div>`;
  if(!tot)h+=`<div style="color:var(--ink-faint);font-size:11px;">Sin gastos registrados.</div>`;
  else{
    Object.keys(bc).sort((a,b)=>bc[b]-bc[a]).forEach(id=>{
      const a=bc[id],p=((a/tot)*100).toFixed(1);
      h+=`<div class="stat-row"><div class="stat-header"><span class="stat-name">${getCatName(id)}</span><span class="stat-val">${formatMoney(a)} (${p}%)</span></div><div class="stat-bar-bg"><div class="stat-bar-fill" style="width:${p}%"></div></div></div>`;
    });
  }
  c.innerHTML=h;
}

function getAvailable(catId,md){
  let ta=0,ts=0;const ck=getMonthKey(md);
  Object.keys(DB.assignments).forEach(m=>{if(m<=ck)ta+=(DB.assignments[m][catId]||0);});
  DB.txs.forEach(t=>{if(t.cat===catId&&t.type==='expense'&&t.date.substring(0,7)<=ck)ts+=t.amt;});
  return ta-ts;
}

function getToAssign(md){
  const ck=getMonthKey(md);let ti=0,ta=0,tg=0;
  DB.txs.forEach(t=>{if(t.type==='income'&&t.date.substring(0,7)<=ck)ti+=t.amt;});
  Object.keys(DB.assignments).forEach(m=>{if(m<=ck)Object.values(DB.assignments[m]).forEach(v=>ta+=v);});
  if(DB.goalFundings)DB.goalFundings.forEach(f=>{const m=DB.goals.find(g=>g.id===f.goalId);if(m&&!m.catId&&f.date.substring(0,7)<=ck)tg+=f.amt;});
  return ti-ta-tg;
}

function updatePills(){
  const mk=getMonthKey(currentMonth);
  const inc=DB.txs.filter(t=>t.type==='income'&&t.amt>0&&t.date.startsWith(mk)).reduce((s,t)=>s+t.amt,0);
  const exp=DB.txs.filter(t=>t.type==='expense'&&t.date.startsWith(mk)).reduce((s,t)=>s+t.amt,0);
  const ca=Object.values(DB.assignments[mk]||{}).reduce((s,v)=>s+v,0);
  let ga=0;if(DB.goalFundings)ga=DB.goalFundings.filter(f=>{const m=DB.goals.find(g=>g.id===f.goalId);return m&&!m.catId&&f.date.startsWith(mk);}).reduce((s,f)=>s+f.amt,0);
  document.getElementById('p-income').innerText=formatMoney(inc);
  document.getElementById('p-spent').innerText=formatMoney(exp);
  document.getElementById('p-assigned').innerText=formatMoney(ca+ga);
}

function getMonthKey(d){return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;}
function formatMoney(n){try{return new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR'}).format(n);}catch(e){return n.toFixed(2)+' â‚¬';}}
function save(){localStorage.setItem('ma_budget_pro_v1',JSON.stringify(DB));}
let toastTimeout=null;
function showToast(msg){const t=document.getElementById('toast');if(toastTimeout)clearTimeout(toastTimeout);t.innerText=msg;t.classList.add('show');toastTimeout=setTimeout(()=>{t.classList.remove('show');toastTimeout=null;},2500);}
function getCatName(id){for(let g of DB.groups){const c=g.cats.find(x=>x.id===id);if(c)return c.name;}return'Eliminada';}
function changeMonth(dir){currentMonth=new Date(currentMonth.getFullYear(),currentMonth.getMonth()+dir,1);updateUI();}

function showPanel(id){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('on'));
  document.querySelectorAll('.ntab').forEach(t=>t.classList.remove('on'));
  document.getElementById('panel-'+id).classList.add('on');
  document.getElementById('tab-'+id).classList.add('on');
}

function openSheet(id){
  if(id==='tx'){
    const s=document.getElementById('f-cat');
    s.innerHTML=DB.groups.map(g=>`<optgroup label="${g.name}">${g.cats.map(c=>`<option value="${c.id}">${c.name}</option>`).join('')}</optgroup>`).join('');
    document.getElementById('f-amt').value='';document.getElementById('f-payee').value='';
    document.getElementById('f-date').valueAsDate=new Date();setTxType('expense');
  }
  if(id==='new-goal'){
    document.getElementById('g-name').value='';document.getElementById('g-target').value='';document.getElementById('g-icon').value='';
    const cs=document.getElementById('g-cat');let o=`<option value="">â€” Sin vincular â€”</option>`;
    DB.groups.forEach(g=>{if(g.cats.length>0){o+=`<optgroup label="${g.name}">`;g.cats.forEach(c=>{o+=`<option value="${c.id}">${c.name}</option>`;});o+=`</optgroup>`;}});
    cs.innerHTML=o;
  }
  if(id==='budget-opts'){
    const s=document.getElementById('f-quick-cat');
    s.innerHTML=DB.groups.map(g=>`<optgroup label="${g.name}">${g.cats.map(c=>`<option value="${c.id}">${c.name}</option>`).join('')}</optgroup>`).join('');
    document.getElementById('f-quick-amt').value='';
  }
  if(id==='new-group')document.getElementById('ng-name').value='';
  document.getElementById('ov-'+id).classList.add('open');
}

function openFundSheet(gid,btn){
  activeGoalId=gid;let n;
  if(typeof btn==='string')n=btn;else if(btn&&btn.dataset)n=btn.dataset.name;
  else{const g=DB.goals.find(g=>g.id===gid);n=g?g.name:'';}
  document.getElementById('fund-title').innerText='Aportar: '+n;
  document.getElementById('f-goal-amt').value='';
  document.getElementById('ov-fund-goal').classList.add('open');
}

function closeSheet(e){if(e&&e.type==='click'&&!e.target.classList.contains('overlay'))return;document.querySelectorAll('.overlay').forEach(o=>o.classList.remove('open'));}

function setTxType(t){
  currentTxType=t;
  document.getElementById('type-exp').className='type-btn '+(t==='expense'?'active':'inactive');
  document.getElementById('type-inc').className='type-btn '+(t==='income'?'active':'inactive');
  document.getElementById('f-cat').style.display=t==='expense'?'block':'none';
}

function saveGroup(){const n=document.getElementById('ng-name').value.trim();if(!n){showToast('Nombre vacÃ­o');return;}DB.groups.push({id:'g_'+Date.now()+'_'+Math.random().toString(36).substr(2,5),name:n,cats:[]});closeSheet();updateUI();showToast('Grupo creado');}
function openNewCatSheet(gid){activeTargetGroup=gid;document.getElementById('nc-emoji').value='';document.getElementById('nc-name').value='';document.getElementById('ov-new-cat').classList.add('open');}
function saveNewCategory(){const n=document.getElementById('nc-name').value.trim(),e=document.getElementById('nc-emoji').value.trim()||'ğŸ“';if(!n){showToast('Nombre vacÃ­o');return;}const g=DB.groups.find(g=>g.id===activeTargetGroup);if(g){g.cats.push({id:'c_'+Date.now()+'_'+Math.random().toString(36).substr(2,5),name:n,emoji:e});closeSheet();updateUI();showToast('CategorÃ­a aÃ±adida');}}
function openEditCat(gId,cId){activeEditCat={gId,cId};const g=DB.groups.find(g=>g.id===gId),c=g.cats.find(c=>c.id===cId);document.getElementById('e-cat-emoji').value=c.emoji||'';document.getElementById('e-cat-name').value=c.name||'';document.getElementById('ov-edit-cat').classList.add('open');}
function saveEditCategory(){const e=document.getElementById('e-cat-emoji').value.trim(),n=document.getElementById('e-cat-name').value.trim();if(!n){showToast('Nombre vacÃ­o');return;}const g=DB.groups.find(g=>g.id===activeEditCat.gId),c=g.cats.find(c=>c.id===activeEditCat.cId);c.name=n;if(e)c.emoji=e;closeSheet();updateUI();showToast('Actualizada');}
function deleteCategory(){if(confirm('Â¿Eliminar esta categorÃ­a?')){const g=DB.groups.find(g=>g.id===activeEditCat.gId);g.cats=g.cats.filter(c=>c.id!==activeEditCat.cId);Object.keys(DB.assignments).forEach(m=>{delete DB.assignments[m][activeEditCat.cId];});DB.goals.forEach(g=>{if(g.catId===activeEditCat.cId)g.catId=null;});closeSheet();updateUI();showToast('Eliminada');}}
function quickAssign(){const c=document.getElementById('f-quick-cat').value,a=parseFloat(document.getElementById('f-quick-amt').value);if(!c||isNaN(a)||a===0){showToast('Importe no vÃ¡lido');return;}const mk=getMonthKey(currentMonth);if(!DB.assignments[mk])DB.assignments[mk]={};DB.assignments[mk][c]=(DB.assignments[mk][c]||0)+a;closeSheet();updateUI();showToast('Asignado');}
function saveTx(){const a=parseFloat(document.getElementById('f-amt').value),d=document.getElementById('f-date').value;if(!a||a<=0||!d){showToast('Importe no vÃ¡lido');return;}const c=currentTxType==='expense'?document.getElementById('f-cat').value:null;if(currentTxType==='expense'&&!c){showToast('Selecciona categorÃ­a');return;}DB.txs.push({id:Date.now().toString()+'_'+Math.random().toString(36).substr(2,5),amt:a,payee:document.getElementById('f-payee').value.trim(),date:d,cat:c,type:currentTxType});closeSheet();updateUI();showToast('Guardado');}
function deleteTx(id){if(confirm('Â¿Eliminar este registro?')){DB.txs=DB.txs.filter(t=>t.id!==id);updateUI();showToast('Eliminado');}}
function saveGoal(){const n=document.getElementById('g-name').value.trim(),t=parseFloat(document.getElementById('g-target').value),i=document.getElementById('g-icon').value.trim()||'ğŸ¯',c=document.getElementById('g-cat').value||null;if(!n||!t||t<=0){showToast('Datos incompletos');return;}DB.goals.push({id:'goal_'+Date.now()+'_'+Math.random().toString(36).substr(2,5),name:n,target:t,icon:i,catId:c});closeSheet();updateUI();showToast('Meta creada');}
function fundAllAvailable(){const a=getToAssign(currentMonth);if(a>0)document.getElementById('f-goal-amt').value=a.toFixed(2);else showToast('Sin fondos');}
function saveFunding(){const a=parseFloat(document.getElementById('f-goal-amt').value);if(isNaN(a)||a===0){showToast('Importe no vÃ¡lido');return;}const m=DB.goals.find(g=>g.id===activeGoalId);if(!m)return;if(m.catId){const mk=getMonthKey(currentMonth);if(!DB.assignments[mk])DB.assignments[mk]={};DB.assignments[mk][m.catId]=(DB.assignments[mk][m.catId]||0)+a;}else{const ds=`${currentMonth.getFullYear()}-${String(currentMonth.getMonth()+1).padStart(2,'0')}-01`;DB.goalFundings.push({id:'fund_'+Date.now()+'_'+Math.random().toString(36).substr(2,5),goalId:activeGoalId,amt:a,date:ds});}closeSheet();updateUI();showToast(a>0?'Fondos aportados':'Fondos retirados');}
function deleteGoal(id){if(confirm('Â¿Eliminar esta meta?')){DB.goals=DB.goals.filter(g=>g.id!==id);DB.goalFundings=DB.goalFundings.filter(f=>f.goalId!==id);updateUI();showToast('Eliminada');}}

async function exportData(){
  const ds=JSON.stringify(DB,null,2),fn=`mabudget_${getMonthKey(new Date())}.json`;
  const bl=new Blob([ds],{type:'application/json'}),fi=new File([bl],fn,{type:'application/json'});
  try{
    if(navigator.canShare&&navigator.canShare({files:[fi]})){await navigator.share({title:'é–“ Ma Budget',files:[fi]});showToast('Exportado');return;}
    if(window.showSaveFilePicker){const h=await window.showSaveFilePicker({suggestedName:fn,types:[{description:'JSON',accept:{'application/json':['.json']}}]});const w=await h.createWritable();await w.write(bl);await w.close();showToast('Exportado');return;}
    const u=URL.createObjectURL(bl),a=document.createElement('a');a.href=u;a.download=fn;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(u);showToast('Descargado');
  }catch(e){if(e.name!=='AbortError')showToast('Error');}
}

function importData(ev){
  const f=ev.target.files[0];if(!f)return;
  const r=new FileReader();
  r.onload=function(e){
    try{const d=JSON.parse(e.target.result);if(d.groups&&d.txs){DB=d;if(!DB.goals)DB.goals=[];if(!DB.goalFundings)DB.goalFundings=[];if(!DB.settings)DB.settings={currency:'EUR',startDate:new Date().toISOString()};DB.settings.currency='EUR';save();updateUI();showToast('Restaurado');}else throw 0;}
    catch(e){showToast('Archivo daÃ±ado');}
    document.getElementById('import-file').value='';
  };r.readAsText(f);
}

function resetApp(){if(confirm('Â¿Borrar todo y empezar de cero?')){localStorage.removeItem('ma_budget_pro_v1');location.reload();}}

window.onload=init;
</script>

</body>
</html>

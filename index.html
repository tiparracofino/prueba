<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>間 Ma Budget</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500&family=Noto+Sans+JP:wght@300;400&display=swap" rel="stylesheet">
<style>
/* ESTILOS BASE */
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
body { height:100%; font-family:'Noto Sans JP',sans-serif; font-size:14px; color:#1a1a18; background:#f0ece3; overflow:hidden; }
#app { display:flex; flex-direction:column; height:100vh; }

/* CABECERA */
#header { background-color:#1a1a18; padding-top:max(env(safe-area-inset-top), 20px); }
#top-bar { display:flex; align-items:center; justify-content:space-between; padding:10px 18px 16px; }
.logo { font-family:'Cormorant Garamond',serif; font-size:22px; color:#c4a46a; letter-spacing:.1em; cursor:pointer; }
.month-nav { display:flex; align-items:center; background:rgba(255,255,255,.12); border-radius:99px; }
.mnbtn { width:44px; height:34px; background:none; border:none; color:#fff; font-size:18px; cursor:pointer; }
#month-lbl { color:#fff; min-width:110px; text-align:center; font-family:'Cormorant Garamond',serif; }

#pills { display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; padding:0 18px 18px; }
.pill { background:rgba(255,255,255,.10); border-radius:10px; padding:10px 8px; text-align:center; }
.pill-lbl { font-size:9px; text-transform:uppercase; color:rgba(255,255,255,.45); }
.pill-val { font-family:'Cormorant Garamond',serif; font-size:18px; color:#fff; }
.pill-val.g { color:#8fcc7a; } .pill-val.r { color:#d47a7a; }

/* BANNER */
#banner { background-color:#4a6741; display:flex; align-items:center; justify-content:space-between; padding:16px 18px; color:#fff; }
#to-assign { font-family:'Cormorant Garamond',serif; font-size:28px; color:#c8e8b0; cursor:pointer; border-bottom:1px dashed rgba(255,255,255,.3); }

/* SCROLL AREA */
#scroll { flex:1; overflow-y:auto; padding-bottom:100px; }
.panel { display:none; } .panel.on { display:block; }

/* TABLA PRESUPUESTO */
#col-hdr { display:grid; grid-template-columns:1fr 85px 85px; padding:10px 18px; background:#f0ece3; position:sticky; top:0; z-index:9; border-bottom:1px solid rgba(0,0,0,.08); }
.ch { font-size:9px; color:#888; text-transform:uppercase; }
.g-row { display:grid; grid-template-columns:1fr 85px 85px; padding:12px 18px; background:#e6e2d8; border-top:1px solid rgba(0,0,0,.07); font-weight:500; }
.c-row { display:grid; grid-template-columns:1fr 85px 85px; padding:12px 18px 12px 24px; background:#fdfbf7; border-top:1px solid rgba(0,0,0,.04); align-items:center; }
.c-avail.pos { color:#4a6741; font-weight:500; } .c-avail.neg { color:#b04a4a; }

/* TX ITEMS */
.tx-item { display:flex; align-items:center; padding:14px 18px; background:#fdfbf7; border-top:1px solid rgba(0,0,0,0.04); gap:12px; }
.tx-amt.income { color:#4a6741; font-weight:500; }

/* INFORMES (GRAFICO) */
.rep-card { background:#fdfbf7; border-radius:18px; padding:20px; margin:18px; border:1px solid rgba(0,0,0,.06); }
.chart-container { display:flex; align-items:center; gap:20px; }
.chart-svg { width:100px; height:100px; transform:rotate(-90deg); }

/* NAVEGACIÓN */
#nav { position:fixed; bottom:0; width:100%; background:#1a1a18; display:flex; height:60px; padding-bottom:env(safe-area-inset-bottom); }
.ntab { flex:1; background:none; border:none; color:rgba(255,255,255,0.3); font-size:11px; text-transform:uppercase; cursor:pointer; }
.ntab.on { color:#c4a46a; }

/* MODALES */
.overlay { position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:200; display:flex; align-items:flex-end; opacity:0; pointer-events:none; transition:opacity 0.3s; backdrop-filter: blur(4px); }
.overlay.open { opacity:1; pointer-events:all; }
.sheet { background:#fdfbf7; width:100%; padding:20px 24px 40px; border-radius:24px 24px 0 0; transform:translateY(100%); transition:transform 0.3s ease-out; }
.overlay.open .sheet { transform:translateY(0); }
.sh-handle { width:40px; height:4px; background:#d0ccc4; border-radius:2px; margin:0 auto 20px; }

/* BOTONES Y FORMS */
.finp { width:100%; background:#e6e2d8; border:none; border-radius:12px; padding:12px; margin-top:4px; font-size:16px; }
.sbtn { width:100%; background:#4a6741; color:#fff; border:none; border-radius:14px; padding:16px; font-weight:500; cursor:pointer; margin-top:10px; }
#fab { position:fixed; right:20px; bottom:80px; width:56px; height:56px; background:#4a6741; color:#fff; border-radius:50%; border:none; font-size:24px; box-shadow:0 4px 12px rgba(0,0,0,0.3); }
</style>
</head>
<body>

<div id="app">
  <div id="header">
    <div id="top-bar">
      <div class="logo">間 Ma</div>
      <div class="month-nav">
        <button class="mnbtn" onclick="chMonth(-1)">‹</button>
        <span id="month-lbl"></span>
        <button class="mnbtn" onclick="chMonth(1)">›</button>
      </div>
      <button class="mnbtn" style="font-size:24px" onclick="openSh('cat')">+</button>
    </div>
    <div id="pills">
      <div class="pill"><span class="pill-lbl">Ingresos</span><div class="pill-val g" id="p-income">€0</div></div>
      <div class="pill"><span class="pill-lbl">Saldo</span><div class="pill-val" id="p-assigned">€0</div></div>
      <div class="pill"><span class="pill-lbl">Gastado</span><div class="pill-val r" id="p-spent">€0</div></div>
    </div>
  </div>

  <div id="banner">
    <div><div style="font-size:9px; text-transform:uppercase">Para asignar</div><div id="to-assign">€0,00</div></div>
    <div style="text-align:right"><div id="age-num" style="font-size:24px">0</div><div style="font-size:8px">DÍAS DINERO</div></div>
  </div>

  <div id="scroll">
    <div class="panel on" id="panel-budget">
      <div id="col-hdr"><span>Categoría</span><span style="text-align:right">Asignado</span><span style="text-align:right">Disponible</span></div>
      <div id="b-body"></div>
    </div>
    <div class="panel" id="panel-tx"><div id="tx-body"></div></div>
    <div class="panel" id="panel-rep"><div id="rep-body"></div></div>
  </div>

  <button id="fab" onclick="openSh('tx')">+</button>

  <nav id="nav">
    <button class="ntab on" id="tab-budget" onclick="showPanel('budget')">Plan</button>
    <button class="ntab" id="tab-tx" onclick="showPanel('tx')">Movs</button>
    <button class="ntab" id="tab-rep" onclick="showPanel('rep')">Info</button>
  </nav>
</div>

<div class="overlay" id="ov-tx">
  <div class="sheet">
    <div class="sh-handle"></div>
    <h2 style="margin-bottom:15px; font-family:'Cormorant Garamond'">Nueva Operación</h2>
    <div style="display:flex; gap:10px; margin-bottom:15px">
      <button class="sbtn" id="btn-t-exp" onclick="setType('expense')" style="background:#e6e2d8; color:#000">Gasto</button>
      <button class="sbtn" id="btn-t-inc" onclick="setType('income')" style="background:#e6e2d8; color:#000">Ingreso</button>
    </div>
    <input type="number" class="finp" id="f-amt" placeholder="Importe €">
    <input type="text" class="finp" id="f-pay" placeholder="Concepto (ej. Nómina)">
    <div id="f-cat-fg"><select class="finp" id="f-cat"></select></div>
    <input type="date" class="finp" id="f-date">
    <button class="sbtn" onclick="saveTx()">Guardar Movimiento</button>
  </div>
</div>

<div class="overlay" id="ov-cat">
  <div class="sheet">
    <div class="sh-handle"></div>
    <h2 style="margin-bottom:15px">Nueva Categoría</h2>
    <input type="text" class="finp" id="c-newg" placeholder="Nombre del Grupo (ej. Vivienda)">
    <input type="text" class="finp" id="c-nm" placeholder="Nombre Categoría (ej. Alquiler)">
    <button class="sbtn" onclick="saveCat()">Crear</button>
  </div>
</div>

<div id="toast"></div>

<script>
// ESTADO INICIAL
let S = JSON.parse(localStorage.getItem('ma-v8')) || { groups: [], monthData: {}, txs: [] };
let currentMonth = new Date();
let txType = 'expense';

const ef = n => '€' + Math.abs(n).toFixed(2).replace('.',',');
const monthKey = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;

function save() { localStorage.setItem('ma-v8', JSON.stringify(S)); }

// CIERRE AUTOMÁTICO AL TOCAR FUERA (Tu petición específica)
document.querySelectorAll('.overlay').forEach(overlay => {
  overlay.addEventListener('click', (e) => {
    // Si el clic es en el overlay (fondo) y no en la tarjeta (sheet)
    if (e.target.classList.contains('overlay')) {
      closeAllSheets();
    }
  });
});

function closeAllSheets() {
  document.querySelectorAll('.overlay').forEach(o => o.classList.remove('open'));
}

function openSh(id) {
  if(id === 'tx') {
    document.getElementById('f-date').value = new Date().toISOString().split('T')[0];
    populateCats();
    setType('expense');
  }
  document.getElementById('ov-' + id).classList.add('open');
}

function setType(t) {
  txType = t;
  document.getElementById('btn-t-exp').style.background = t === 'expense' ? '#4a6741' : '#e6e2d8';
  document.getElementById('btn-t-exp').style.color = t === 'expense' ? '#fff' : '#000';
  document.getElementById('btn-t-inc').style.background = t === 'income' ? '#4a6741' : '#e6e2d8';
  document.getElementById('btn-t-inc').style.color = t === 'income' ? '#fff' : '#000';
  document.getElementById('f-cat-fg').style.visibility = t === 'income' ? 'hidden' : 'visible';
}

function populateCats() {
  const sel = document.getElementById('f-cat');
  sel.innerHTML = S.groups.map(g => `<optgroup label="${g.name}">${g.cats.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}</optgroup>`).join('');
}

function saveTx() {
  const amt = parseFloat(document.getElementById('f-amt').value);
  if(!amt) return;
  const tx = {
    id: Date.now(),
    amt: amt,
    pay: document.getElementById('f-pay').value || 'Sin concepto',
    cat: txType === 'income' ? null : document.getElementById('f-cat').value,
    date: document.getElementById('f-date').value,
    month: document.getElementById('f-date').value.slice(0,7),
    type: txType
  };
  S.txs.push(tx);
  save();
  closeAllSheets();
  fullRender();
}

function saveCat() {
  const gNm = document.getElementById('c-newg').value;
  const cNm = document.getElementById('c-nm').value;
  if(!gNm || !cNm) return;
  let g = S.groups.find(x => x.name === gNm);
  if(!g) { g = { name: gNm, cats: [] }; S.groups.push(g); }
  g.cats.push({ id: Date.now(), name: cNm });
  save();
  closeAllSheets();
  fullRender();
}

function fullRender() {
  const mk = monthKey(currentMonth);
  document.getElementById('month-lbl').textContent = currentMonth.toLocaleDateString('es-ES', { month:'long', year:'numeric' }).toUpperCase();
  
  // Totales
  const inc = S.txs.filter(t => t.month === mk && t.type === 'income').reduce((s,t) => s + t.amt, 0);
  const exp = S.txs.filter(t => t.month === mk && t.type === 'expense').reduce((s,t) => s + t.amt, 0);
  document.getElementById('p-income').textContent = ef(inc);
  document.getElementById('p-spent').textContent = ef(exp);
  
  // Budget render
  const body = document.getElementById('b-body');
  body.innerHTML = S.groups.map(g => `
    <div class="g-row"><div>${g.name}</div><div style="text-align:right">--</div><div style="text-align:right">--</div></div>
    ${g.cats.map(c => `
      <div class="c-row">
        <div>${c.name}</div>
        <div style="text-align:right; color:#888" onclick="editAssigned('${c.id}')">${ef(S.monthData[mk]?.assignments?.[c.id] || 0)}</div>
        <div class="c-avail pos" style="text-align:right">${ef(0)}</div>
      </div>
    `).join('')}
  `).join('');

  // Tx render
  document.getElementById('tx-body').innerHTML = S.txs.filter(t => t.month === mk).map(t => `
    <div class="tx-item">
      <div style="flex:1"><b>${t.pay}</b><br><small>${t.date}</small></div>
      <div class="tx-amt ${t.type}">${t.type==='income'?'+':'-'}${ef(t.amt)}</div>
    </div>
  `).join('');
}

function editAssigned(id) {
  const val = prompt("Cantidad a asignar:");
  if(val === null) return;
  const mk = monthKey(currentMonth);
  if(!S.monthData[mk]) S.monthData[mk] = { assignments: {} };
  S.monthData[mk].assignments[id] = parseFloat(val) || 0;
  save();
  fullRender();
}

function showPanel(id) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('on'));
  document.querySelectorAll('.ntab').forEach(n => n.classList.remove('on'));
  document.getElementById('panel-'+id).classList.add('on');
  document.getElementById('tab-'+id).classList.add('on');
}

function chMonth(n) {
  currentMonth.setMonth(currentMonth.getMonth() + n);
  fullRender();
}

fullRender();
</script>
</body>
</html>

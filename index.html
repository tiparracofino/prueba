<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Èñì Ma Budget</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500&family=Noto+Sans+JP:wght@300;400&display=swap" rel="stylesheet">
<style>
/* SISTEMA DE DISE√ëO: MA (ESPACIO NEGATIVO) */
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
html { height:100%; }
body { height:100%; font-family:'Noto Sans JP',sans-serif; font-size:14px; font-weight:300; color:#1a1a18; background:#f0ece3; overflow:hidden; -webkit-font-smoothing:antialiased; }
#app { display:flex; flex-direction:column; height:100%; }

/* CABECERA */
#header { background-color:#1a1a18; flex-shrink:0; padding-top:max(env(safe-area-inset-top), 20px); }
#top-bar { display:flex; align-items:center; justify-content:space-between; padding:10px 18px 16px; gap:8px; }
.logo { font-family:'Cormorant Garamond',serif; font-size:22px; font-weight:300; color:#c4a46a; letter-spacing:.1em; cursor:pointer; }
.month-nav { display:flex; align-items:center; background-color:rgba(255,255,255,.12); border-radius:99px; overflow:hidden; }
.mnbtn { width:44px; height:34px; background:none; border:none; color:rgba(255,255,255,.8); font-size:18px; cursor:pointer; display:flex; align-items:center; justify-content:center; }
#month-lbl { color:#fff; font-family:'Cormorant Garamond',serif; font-size:16px; letter-spacing:.05em; min-width:110px; text-align:center; }
.hdr-btn { width:36px; height:36px; background-color:rgba(255,255,255,.12); border:none; border-radius:50%; color:rgba(255,255,255,.85); font-size:20px; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0; }

#pills { display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; padding:0 18px 18px; }
.pill { background-color:rgba(255,255,255,.10); border-radius:10px; padding:10px 8px; text-align:center; }
.pill-lbl { display:block; font-size:9px; letter-spacing:.13em; text-transform:uppercase; color:rgba(255,255,255,.45); margin-bottom:4px; }
.pill-val { font-family:'Cormorant Garamond',serif; font-size:18px; color:#fff; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.pill-val.g { color:#8fcc7a; } .pill-val.a { color:#ddb96a; } .pill-val.r { color:#d47a7a; }

/* BANNER */
#banner { background-color:#4a6741; display:flex; align-items:center; justify-content:space-between; padding:16px 18px; flex-shrink:0; box-shadow:0 2px 10px rgba(0,0,0,0.1); z-index: 10; }
.banner-lbl { font-size:9px; letter-spacing:.14em; text-transform:uppercase; color:rgba(255,255,255,.7); margin-bottom:2px; }
#to-assign { font-family:'Cormorant Garamond',serif; font-size:28px; font-weight:300; color:#c8e8b0; cursor:pointer; border-bottom:1px dashed rgba(255,255,255,.3); line-height: 1.1; }
#to-assign.deficit { color:#f0b0b0; }
.age-box { background-color:rgba(0,0,0,.20); border-radius:20px; padding:6px 16px; text-align:center; cursor:pointer; }
#age-num { font-family:'Cormorant Garamond',serif; font-size:24px; line-height:1; color:#fff; }
.age-lbl { font-size:8px; letter-spacing:.1em; text-transform:uppercase; color:rgba(255,255,255,.6); }

/* √ÅREA DE SCROLL */
#scroll { flex:1; overflow-y:auto; overflow-x:hidden; -webkit-overflow-scrolling:touch; padding-bottom:100px; position: relative; }
.panel { display:none; animation: fadeIn 0.2s ease; } .panel.on { display:block; }
@keyframes fadeIn { from { opacity:0; transform:translateY(5px); } to { opacity:1; transform:translateY(0); } }

/* TABLA PRESUPUESTO */
#col-hdr { display:grid; grid-template-columns:1fr 85px 85px; padding:10px 18px 8px; position:sticky; top:0; z-index:9; background-color:#f0ece3; border-bottom:1px solid rgba(0,0,0,.08); font-weight: 500; }
.ch { font-size:9px; letter-spacing:.13em; text-transform:uppercase; color:#888884; } .ch:not(:first-child) { text-align:right; }

/* GRUPOS */
.g-row { display:grid; grid-template-columns:1fr 85px 85px; padding:12px 18px; background-color:#e6e2d8; border-top:1px solid rgba(0,0,0,.07); cursor:pointer; user-select:none; align-items:center; }
.g-title { display:flex; align-items:center; gap:6px; font-size:11px; letter-spacing:.12em; text-transform:uppercase; color:#3a3a36; font-weight:500; }
.chevron { font-size:9px; color:#888884; transition:transform .2s; } .g-row.closed .chevron { transform:rotate(-90deg); }
.g-num { font-family:'Cormorant Garamond',serif; font-size:15px; color:#3a3a36; text-align:right; font-weight: 500; }

/* CATEGOR√çAS */
.c-rows.hidden { display:none; }
.c-row { display:grid; grid-template-columns:1fr 85px 85px; padding:12px 18px 12px 24px; background-color:#fdfbf7; border-top:1px solid rgba(0,0,0,.04); align-items:center; position: relative; }
.c-row.over { border-left:3px solid #b04a4a; padding-left:21px; }
.c-info { display:flex; align-items:center; gap:10px; min-width:0; }
.c-emo { font-size:16px; flex-shrink:0; width: 24px; text-align: center; }
.c-txt { min-width:0; flex:1; }
.c-name { font-size:14px; color:#1a1a18; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.c-prog { height:3px; background:rgba(0,0,0,.06); border-radius:2px; margin-top:5px; overflow:hidden; width: 90%; }
.c-prog-fill { height:100%; background-color:#6a9a5c; border-radius:2px; }
.c-prog-fill.ov { background-color:#b04a4a; }
.c-assigned { font-family:'Cormorant Garamond',serif; font-size:17px; color:#3a3a36; text-align:right; cursor:pointer; padding:4px 6px; border-radius:6px; position:relative; transition: background .1s; }
.c-assigned:active { background-color: rgba(0,0,0,0.05); }
.c-assigned.editing { background-color:#fff; outline:2px solid #4a6741; box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 5; }
.c-inp { position:absolute; inset:0; background:transparent; border:none; outline:none; font-family:'Cormorant Garamond',serif; font-size:17px; text-align:right; color:#1a1a18; padding:0 6px; display:none; width:100%; border-radius: 6px; }
.c-avail { font-family:'Cormorant Garamond',serif; font-size:17px; text-align:right; padding-right:2px; font-weight: 500; }
.c-avail.pos { color:#4a6741; } .c-avail.neg { color:#b04a4a; } .c-avail.zer { color:#ccc; }
.add-cat { padding:14px 18px 14px 30px; background-color:#fdfbf7; border-top:1px solid rgba(0,0,0,.04); color:#4a6741; font-size:12px; letter-spacing:.04em; cursor:pointer; font-weight: 500; }

/* TRANSACCIONES */
.tx-sticky { padding:12px 18px 8px; font-size:9px; letter-spacing:.13em; text-transform:uppercase; color:#888884; background-color:#f0ece3; position:sticky; top:0; z-index:8; border-bottom:1px solid rgba(0,0,0,.07); display:flex; justify-content:space-between; align-items:center; }
.tx-swipe-wrap { position:relative; overflow:hidden; background-color:#b04a4a; }
.tx-swipe-wrap .tx-del-bg { position:absolute; right:0; top:0; bottom:0; width:80px; display:flex; align-items:center; justify-content:center; background-color:#b04a4a; color:#fff; font-size:13px; letter-spacing:.05em; flex-direction:column; gap:2px; pointer-events:none; }
.tx-item { display:flex; align-items:center; padding:14px 18px; background-color:#fdfbf7; border-top:1px solid rgba(0,0,0,.04); gap:14px; cursor:pointer; transition:background .12s; position:relative; transform:translateX(0); will-change:transform; touch-action:pan-y; }
.tx-item:active { background-color:#e6e2d8; }
.tx-icon { width:42px; height:42px; border-radius:50%; background-color:#e6e2d8; display:flex; align-items:center; justify-content:center; font-size:18px; flex-shrink:0; position:relative; color: #555; }
.tx-dot { position:absolute; top:0; right:0; width:10px; height:10px; background-color:#c4a46a; border-radius:50%; border:2px solid #fdfbf7; }
.tx-recurring-dot { position:absolute; bottom:-2px; right:-2px; width:14px; height:14px; background-color:#3a6878; border-radius:50%; border:2px solid #fdfbf7; font-size:9px; display:flex; align-items:center; justify-content:center; color:#fff; }
.tx-mid { flex:1; min-width:0; }
.tx-payer { font-size:15px; color:#1a1a18; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-weight: 400; }
.tx-sub { font-size:12px; color:#888884; margin-top:3px; display: flex; align-items: center; gap: 4px; }
.tx-right { text-align:right; flex-shrink:0; }
.tx-amt { font-family:'Cormorant Garamond',serif; font-size:19px; font-weight: 500; }
.tx-amt.inc { color:#4a6741; } .tx-amt.exp { color:#1a1a18; }
.tx-dt { font-size:11px; color:#aaa; margin-top:3px; }
.rec-badge { display:inline-block; font-size:8px; letter-spacing:.05em; background-color:#c0d4dc; color:#3a6878; border-radius:4px; padding:1px 4px; text-transform: uppercase; }

/* BARRA NAVEGACI√ìN */
#nav { position:fixed; bottom:0; left:0; right:0; background-color:#1a1a18; display:flex; z-index:99; padding-bottom:env(safe-area-inset-bottom,0); border-top:1px solid rgba(255,255,255,.07); height: calc(60px + env(safe-area-inset-bottom,0)); }
.ntab { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:6px 4px 0; gap:5px; background:none; border:none; cursor:pointer; color:rgba(255,255,255,.35); transition:color .15s; }
.ntab.on { color:#c4a46a; } .ntab:active { color:rgba(255,255,255,.65); }
.nicon { font-size:20px; line-height:1; } .nlbl { font-size:9px; letter-spacing:.08em; text-transform:uppercase; }

/* BOT√ìN FLOTANTE (FAB) */
#fab { position:fixed; right:20px; bottom:calc(75px + env(safe-area-inset-bottom,0px)); width:56px; height:56px; background-color:#4a6741; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:28px; color:#fff; cursor:pointer; border:none; z-index:50; box-shadow:0 4px 18px rgba(74,103,65,.6); transition:transform .15s; }
#fab:active { transform:scale(.9); }

/* VENTANAS EMERGENTES (SHEETS) */
.overlay { position:fixed; inset:0; background:rgba(0,0,0,.52); z-index:200; display:flex; align-items:flex-end; opacity:0; pointer-events:none; transition:opacity .22s; backdrop-filter: blur(2px); }
.overlay.open { opacity:1; pointer-events:all; }
.sheet { background-color:#fdfbf7; border-radius:24px 24px 0 0; width:100%; padding:20px 24px calc(24px + env(safe-area-inset-bottom,0)); transform:translateY(100%); transition:transform .25s cubic-bezier(0.16, 1, 0.3, 1); max-height:90vh; overflow-y:auto; display: flex; flex-direction: column; }
.overlay.open .sheet { transform:translateY(0); }
.sh-handle { width:40px; height:5px; background-color:#d0ccc4; border-radius:3px; margin:0 auto 24px; flex-shrink: 0; }
.sh-title { font-family:'Cormorant Garamond',serif; font-size:24px; font-weight:300; margin-bottom:20px; color: #1a1a18; }
.fg { margin-bottom:16px; }
.flbl { font-size:10px; letter-spacing:.11em; text-transform:uppercase; color:#888884; display:block; margin-bottom:6px; font-weight: 500; }
.finp { width:100%; background-color:#e6e2d8; border:1.5px solid transparent; border-radius:12px; padding:12px 14px; font-family:'Noto Sans JP',sans-serif; font-size:16px; color:#1a1a18; outline:none; -webkit-appearance:none; appearance:none; transition: all .2s; }
.finp:focus { border-color:#4a6741; background-color:#fff; }
.f2 { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
.type-row { display:flex; gap:8px; margin-bottom:16px; }
.tchip { flex:1; padding:12px; border-radius:12px; border:1.5px solid rgba(0,0,0,.1); background:none; font-size:13px; letter-spacing:.05em; color:#888884; cursor:pointer; font-weight: 500; transition: all .2s; }
.tchip.ae { background-color:#f0d8d8; border-color:#b04a4a; color:#8b3a3a; }
.tchip.ai { background-color:#c8d8bf; border-color:#4a6741; color:#4a6741; }
.sbtn { width:100%; background-color:#4a6741; color:#fff; border:none; border-radius:14px; padding:16px; font-size:15px; letter-spacing:.06em; cursor:pointer; margin-top:8px; font-weight: 500; }
.sbtn:active { transform: scale(0.98); }
.sbtn.danger { background-color:#b04a4a; color: #fff; margin-top:12px; }

/* EXTRAS */
.rec-wrap { background-color:#f0ece3; border-radius:12px; padding:14px; margin-bottom:16px; }
.rec-header { display:flex; align-items:center; justify-content:space-between; }
.rec-header-lbl { font-size:11px; letter-spacing:.1em; text-transform:uppercase; color:#3a6878; font-weight:500; }
.rec-fields { margin-top:14px; display:none; } .rec-fields.on { display:block; }
.toggle-sw { position:relative; width:44px; height:26px; }
.toggle-sw input { opacity:0; width:0; height:0; }
.toggle-track { position:absolute; inset:0; background-color:#d0ccc4; border-radius:13px; cursor:pointer; transition:background .2s; }
.toggle-track::before { content:''; position:absolute; width:22px; height:22px; left:2px; bottom:2px; background:#fff; border-radius:50%; transition:transform .2s; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
.toggle-sw input:checked + .toggle-track { background-color:#3a6878; }
.toggle-sw input:checked + .toggle-track::before { transform:translateX(18px); }

/* AJUSTES E INFORMES */
.set-section { padding:20px 18px 8px; font-size:10px; letter-spacing:.13em; text-transform:uppercase; color:#888884; font-weight: 600; }
.set-row { display:flex; align-items:center; justify-content:space-between; padding:16px 18px; background-color:#fdfbf7; border-top:1px solid rgba(0,0,0,.04); cursor:pointer; }
.set-row:active { background-color:#e6e2d8; }
.set-lbl { font-size:15px; color:#1a1a18; }
.set-val { font-family:'Cormorant Garamond',serif; font-size:17px; color:#4a6741; }
.rep-wrap { padding:18px; }
.rep-card { background-color:#fdfbf7; border-radius:18px; border:1px solid rgba(0,0,0,.06); padding:20px; margin-bottom:16px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
.rep-ttl { font-family:'Cormorant Garamond',serif; font-size:19px; font-weight:400; margin-bottom:18px; color:#1a1a18; }
.ie-row2 { display:flex; gap:12px; margin-bottom:20px; }
.ie-box2 { flex:1; background-color:#f0ece3; border-radius:12px; padding:14px; }
.ie-lbl2 { font-size:9px; letter-spacing:.13em; text-transform:uppercase; color:#888884; margin-bottom:6px; }
.ie-v { font-family:'Cormorant Garamond',serif; font-size:24px; }
.ie-v.inc { color:#4a6741; } .ie-v.exp { color:#b04a4a; }
.bar-ch { display:flex; align-items:flex-end; gap:6px; height:80px; }
.bar-w { flex:1; display:flex; flex-direction:column; align-items:center; gap:6px; height:100%; justify-content:flex-end; }
.bar-b { width:100%; background-color:#c8d8bf; border-radius:4px 4px 0 0; min-height: 4px; } .bar-b.cur { background-color:#4a6741; }
.bar-l { font-size:9px; color:#aaa; }

.sp-list { display:flex; flex-direction:column; gap:12px; }
.sp-item { display:flex; align-items:center; gap:12px; }
.sp-lbl { font-size:13px; width:110px; flex-shrink:0; color:#3a3a36; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.sp-trk { flex:1; height:6px; background-color:#e6e2d8; border-radius:3px; overflow:hidden; }
.sp-bar { height:100%; background-color:#4a6741; border-radius:3px; }
.sp-val { font-family:'Cormorant Garamond',serif; font-size:15px; width:60px; text-align:right; }

/* METAS */
.goals-top { display:flex; align-items:center; justify-content:space-between; padding:14px 18px 12px; border-bottom:1px solid rgba(0,0,0,.07); background-color:#f0ece3; position:sticky; top:0; z-index:8; }
.goals-ttl { font-family:'Cormorant Garamond',serif; font-size:18px; font-weight:300; }
.btn-new { background-color:#4a6741; color:#fff; border:none; padding:8px 16px; border-radius:10px; font-size:12px; cursor:pointer; letter-spacing:.05em; font-weight: 500; }
.goal-card { margin:14px 18px 0; background-color:#fdfbf7; border-radius:18px; padding:20px; border:1px solid rgba(0,0,0,.06); position:relative; overflow:hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.04); }
.goal-stripe { position:absolute; top:0; left:0; right:0; height:4px; }
.goal-stripe.save { background-color:#4a6741; } .goal-stripe.debt { background-color:#b04a4a; } .goal-stripe.spend { background-color:#3a6878; }
.goal-top2 { display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:12px; }
.goal-emo { font-size:28px; }
.gbadge { font-size:9px; letter-spacing:.09em; text-transform:uppercase; padding:4px 10px; border-radius:8px; font-weight: 600; }
.gbadge.save { background-color:#c8d8bf; color:#4a6741; } .gbadge.debt { background-color:#f0d8d8; color:#8b3a3a; } .gbadge.spend { background-color:#c0d4dc; color:#3a6878; }
.goal-name { font-size:16px; font-weight:500; margin-bottom:4px; }
.goal-sub2 { font-size:12px; color:#888884; margin-bottom:14px; }
.goal-trk { height:6px; background-color:#e6e2d8; border-radius:3px; overflow:hidden; margin-bottom:12px; }
.goal-fill { height:100%; border-radius:3px; }
.goal-fill.save { background-color:#4a6741; } .goal-fill.debt { background-color:#b04a4a; } .goal-fill.spend { background-color:#3a6878; }
.goal-stats2 { display:flex; justify-content:space-between; align-items:flex-end; }
.goal-sv { font-family:'Cormorant Garamond',serif; font-size:24px; line-height: 1; }
.goal-tgt { font-size:11px; color:#888884; margin-left: 4px; }
.goal-mon { font-size:13px; font-weight: 500; }
.goal-mon.save { color:#4a6741; } .goal-mon.debt { color:#b04a4a; } .goal-mon.spend { color:#3a6878; }
.icon-btn { background:none; border:none; cursor:pointer; font-size:16px; padding:4px 6px; opacity:.6; }

/* TOAST */
#toast { position:fixed; left:50%; bottom:90px; transform:translateX(-50%) translateY(20px); background-color:#1a1a18; color:#fff; padding:12px 24px; border-radius:30px; font-size:13px; letter-spacing:.05em; opacity:0; pointer-events:none; transition:all .3s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index:300; white-space:nowrap; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
#toast.on { opacity:1; transform:translateX(-50%) translateY(0); }

/* UTIL */
::-webkit-scrollbar { width:4px; }
::-webkit-scrollbar-thumb { background:rgba(0,0,0,0.1); border-radius:2px; }
</style>

</head>
<body>
<div id="app">

  <div id="header">
    <div id="top-bar">
      <div class="logo" onclick="showPanel('settings')">Èñì Ma</div>
      <div class="month-nav">
        <button class="mnbtn" onclick="chMonth(-1)">‚Äπ</button>
        <span id="month-lbl"></span>
        <button class="mnbtn" onclick="chMonth(1)">‚Ä∫</button>
      </div>
      <button class="hdr-btn" onclick="openSh('cat')">Ôºã</button>
    </div>
    <div id="pills">
      <div class="pill"><span class="pill-lbl">Ingresos</span><span class="pill-val g" id="p-income">‚Ç¨0</span></div>
      <div class="pill"><span class="pill-lbl">Saldo Total</span><span class="pill-val a" id="p-assigned">‚Ç¨0</span></div>
      <div class="pill"><span class="pill-lbl">Gastado</span><span class="pill-val r" id="p-spent">‚Ç¨0</span></div>
    </div>
  </div>

  <div id="banner">
    <div>
      <div class="banner-lbl">Para asignar</div>
      <div id="to-assign" onclick="openSh('income')" title="Toca para ver c√≥mo funciona">‚Ç¨0,00</div>
    </div>
    <div class="age-box">
      <div id="age-num">0</div>
      <div class="age-lbl">d√≠as dinero</div>
    </div>
  </div>

  <div id="scroll">

    <div class="panel on" id="panel-budget">
      <div id="col-hdr">
        <span class="ch">Categor√≠a</span>
        <span class="ch" style="text-align:right">Asignado</span>
        <span class="ch" style="text-align:right">Disponible</span>
      </div>
      <div id="b-body"></div>
      <div style="height:20px"></div>
    </div>

    <div class="panel" id="panel-tx">
      <div class="tx-sticky">
        <span>Movimientos del mes</span>
        <span id="tx-rec-count" style="color:#3a6878;font-size:10px;cursor:pointer" onclick="openSh('recurring')"></span>
      </div>
      <div id="tx-body"></div>
      <div style="height:20px"></div>
    </div>

    <div class="panel" id="panel-goals">
      <div class="goals-top">
        <span class="goals-ttl">Metas financieras</span>
        <button class="btn-new" onclick="openSh('goal')">+ Nueva</button>
      </div>
      <div id="g-body"></div>
      <div style="height:20px"></div>
    </div>

    <div class="panel" id="panel-rep">
      <div class="rep-wrap" id="rep-body"></div>
      <div style="height:20px"></div>
    </div>

    <div class="panel" id="panel-settings">
      <div class="set-section">Cuenta</div>
      <div class="set-row" onclick="openSh('income')">
        <span class="set-lbl">üí∞ Ayuda Ingresos</span>
        <span class="set-arrow">‚Ä∫</span>
      </div>
      <div class="set-section" style="margin-top:8px">Transacciones recurrentes</div>
      <div id="rec-list-settings"></div>
      <div class="set-row" onclick="openSh('recurring')">
        <span class="set-lbl">üîÑ Gestionar recurrentes</span>
        <span class="set-arrow">‚Ä∫</span>
      </div>
      <div class="set-section" style="margin-top:8px">Datos</div>
      <div class="set-row" onclick="exportJSON()">
        <span class="set-lbl">üì§ Exportar datos (JSON)</span>
        <span class="set-arrow">‚Ä∫</span>
      </div>
      <div class="set-row" onclick="document.getElementById('import-input').click()">
        <span class="set-lbl">üì• Importar datos (JSON)</span>
        <span class="set-arrow">‚Ä∫</span>
      </div>
      <input type="file" id="import-input" accept=".json" style="display:none" onchange="importJSON(event)">
      <div class="set-row" onclick="confirmReset()">
        <span class="set-lbl" style="color:#b04a4a">üóë Borrar todos los datos</span>
        <span class="set-arrow">‚Ä∫</span>
      </div>
      <div class="set-section" style="margin-top:8px">Grupos de categor√≠as</div>
      <div id="groups-list"></div>
      <div style="height:20px"></div>
    </div>

  </div>

  <button id="fab" onclick="openSh('tx')">Ôºã</button>

  <nav id="nav">
    <button class="ntab on" id="tab-budget" onclick="showPanel('budget')">
      <span class="nicon">‚äû</span><span class="nlbl">Plan</span>
    </button>
    <button class="ntab" id="tab-tx" onclick="showPanel('tx')">
      <span class="nicon">‚â°</span><span class="nlbl">Movs</span>
    </button>
    <button class="ntab" id="tab-goals" onclick="showPanel('goals')">
      <span class="nicon">‚óé</span><span class="nlbl">Metas</span>
    </button>
    <button class="ntab" id="tab-rep" onclick="showPanel('rep')">
      <span class="nicon">‚ñ¶</span><span class="nlbl">Info</span>
    </button>
    <button class="ntab" id="tab-settings" onclick="showPanel('settings')">
      <span class="nicon">‚öô</span><span class="nlbl">Ajustes</span>
    </button>
  </nav>
</div>

<div class="overlay" id="ov-tx">
  <div class="sheet">
    <div class="sh-handle"></div>
    <div class="sh-title" id="tx-sh-title">Nueva transacci√≥n</div>
    <div class="type-row">
      <button class="tchip ae" id="ch-exp" onclick="setType('expense')">Gasto</button>
      <button class="tchip" id="ch-inc" onclick="setType('income')">Ingreso</button>
    </div>
    <div class="f2">
      <div class="fg"><label class="flbl">Fecha</label><input type="date" class="finp" id="f-date"></div>
      <div class="fg"><label class="flbl">Importe ‚Ç¨</label><input type="number" class="finp" id="f-amt" placeholder="0.00" step="0.01" min="0"></div>
    </div>
    <div class="fg"><label class="flbl">Descripci√≥n</label><input type="text" class="finp" id="f-pay" placeholder="ej. Mercadona"></div>
    <div class="fg" id="f-cat-fg"><label class="flbl">Categor√≠a</label><select class="finp" id="f-cat"></select></div>
    <div class="fg"><label class="flbl">Nota (opcional)</label><input type="text" class="finp" id="f-note" placeholder=""></div>
    
    <div class="rec-wrap">
      <div class="rec-header">
        <span class="rec-header-lbl">üîÑ Hacer recurrente</span>
        <label class="toggle-sw">
          <input type="checkbox" id="f-rec-toggle" onchange="toggleRecFields()">
          <div class="toggle-track"></div>
        </label>
      </div>
      <div class="rec-fields" id="rec-fields">
        <div class="f2" style="margin-top:0">
          <div class="fg"><label class="flbl">Frecuencia</label>
            <select class="finp" id="f-rec-freq">
              <option value="monthly">Mensual</option>
              <option value="weekly">Semanal</option>
              <option value="bimonthly">Bimestral</option>
              <option value="quarterly">Trimestral</option>
              <option value="yearly">Anual</option>
            </select>
          </div>
          <div class="fg"><label class="flbl">Termina</label><input type="month" class="finp" id="f-rec-end"></div>
        </div>
      </div>
    </div>

    <button class="sbtn" id="tx-save-btn" onclick="saveTx()">Guardar transacci√≥n</button>
    <button class="sbtn danger" id="tx-del-btn" onclick="deleteTx()" style="display:none">Eliminar transacci√≥n</button>
  </div>
</div>

<div class="overlay" id="ov-recurring">
  <div class="sheet">
    <div class="sh-handle"></div>
    <div class="sh-title">Transacciones recurrentes</div>
    <div id="rec-sheet-body"></div>
    <div style="font-size:12px;color:#888;margin-top:16px;line-height:1.5;text-align:center">
      Se generan autom√°ticamente al inicio de cada mes.
    </div>
  </div>
</div>

<div class="overlay" id="ov-cat">
  <div class="sheet">
    <div class="sh-handle"></div>
    <div class="sh-title" id="cat-sh-title">Nueva categor√≠a</div>
    <div class="fg"><label class="flbl">Grupo</label><select class="finp" id="c-grp"></select></div>
    <div class="fg" id="c-newg-wrap"><label class="flbl">Nombre del grupo nuevo</label><input type="text" class="finp" id="c-newg" placeholder="ej. Hogar"></div>
    <div class="f2">
      <div class="fg"><label class="flbl">Emoji</label><input type="text" class="finp" id="c-emo" placeholder="üìå" maxlength="2"></div>
      <div class="fg"><label class="flbl">Nombre</label><input type="text" class="finp" id="c-nm" placeholder="ej. Alquiler"></div>
    </div>
    <button class="sbtn" id="cat-save-btn" onclick="saveCat()">Crear categor√≠a</button>
  </div>
</div>

<div class="overlay" id="ov-goal">
  <div class="sheet">
    <div class="sh-handle"></div>
    <div class="sh-title" id="goal-sh-title">Nueva meta</div>
    <div class="f2">
      <div class="fg"><label class="flbl">Emoji</label><input type="text" class="finp" id="g-emo" placeholder="üéØ" maxlength="2"></div>
      <div class="fg"><label class="flbl">Tipo</label>
        <select class="finp" id="g-type">
          <option value="save">Ahorro</option>
          <option value="debt">Deuda</option>
          <option value="spend">Gasto futuro</option>
        </select>
      </div>
    </div>
    <div class="fg"><label class="flbl">Nombre</label><input type="text" class="finp" id="g-nm" placeholder="ej. Fondo de emergencia"></div>
    <div class="f2">
      <div class="fg"><label class="flbl">Objetivo ‚Ç¨</label><input type="number" class="finp" id="g-tgt" placeholder="5000"></div>
      <div class="fg"><label class="flbl">Ahorrado ‚Ç¨</label><input type="number" class="finp" id="g-sv" placeholder="0"></div>
    </div>
    <div class="fg"><label class="flbl">Fecha objetivo</label><input type="month" class="finp" id="g-dt"></div>
    <button class="sbtn" id="goal-save-btn" onclick="saveGoal()">Crear meta</button>
    <button class="sbtn danger" id="goal-del-btn" onclick="deleteGoal()" style="display:none">Eliminar meta</button>
  </div>
</div>

<div class="overlay" id="ov-income">
  <div class="sheet">
    <div class="sh-handle"></div>
    <div class="sh-title">C√≥mo registrar ingresos</div>
    <div style="font-size:15px;color:#3a3a36;line-height:1.6;margin-bottom:24px">
      Pulsa <strong>Ôºã</strong> y selecciona <strong>Ingreso</strong> para registrar tu n√≥mina.
      <br><br>
      El n√∫mero grande arriba ("Para asignar") es:
      <div style="background:#e6e2d8;padding:10px;border-radius:8px;margin-top:10px;font-family:'Cormorant Garamond';font-size:18px;text-align:center">
        (Total Ingresos Reales) - (Total Asignado a Categor√≠as)
      </div>
    </div>
    <button class="sbtn" onclick="closeSh('income'); openSh('tx'); setType('income');">‚ûú A√±adir ingreso ahora</button>
  </div>
</div>

<div class="overlay" id="ov-group">
  <div class="sheet">
    <div class="sh-handle"></div>
    <div class="sh-title">Editar grupo</div>
    <div class="fg"><label class="flbl">Nombre del grupo</label><input type="text" class="finp" id="grp-nm" placeholder="ej. Gastos esenciales"></div>
    <button class="sbtn" onclick="saveGroup()">Guardar cambios</button>
    <button class="sbtn danger" onclick="deleteGroup()">Eliminar grupo</button>
  </div>
</div>

<div class="overlay" id="ov-editcat">
  <div class="sheet">
    <div class="sh-handle"></div>
    <div class="sh-title">Editar categor√≠a</div>
    <div class="f2">
      <div class="fg"><label class="flbl">Emoji</label><input type="text" class="finp" id="ec-emo" placeholder="üìå" maxlength="2"></div>
      <div class="fg"><label class="flbl">Nombre</label><input type="text" class="finp" id="ec-nm" placeholder="ej. Alquiler"></div>
    </div>
    <button class="sbtn" onclick="saveEditCat()">Guardar cambios</button>
    <button class="sbtn danger" onclick="deleteEditCat()">Eliminar categor√≠a</button>
  </div>
</div>

<div id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ESTADO & CONFIGURACI√ìN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DEFAULT_STATE = {
  groups: [],
  monthData: {}, // { [YYYY-MM]: { assignments: {catId: number} } }
  txs: [],       // Lista plana de transacciones
  recurringTxs: [],
  recurringDeleted: {},
  goals: [],
  version: 6
};

let S = loadState();
let currentMonth = new Date();
// Variables de edici√≥n temporal
let editingTxId = null;
let editingGoalId = null;
let editingGrpId = null;
let editingCatId = null;
let txType = 'expense';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// L√ìGICA DE PRESUPUESTO (MATEM√ÅTICA DE SOBRES)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Genera la clave YYYY-MM
function monthKey(d) {
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
}

// Obtiene datos (asignaciones) para un mes espec√≠fico
function getMonthData(mk) {
  if (!S.monthData) S.monthData = {};
  if (!S.monthData[mk]) S.monthData[mk] = { assignments: {} };
  return S.monthData[mk];
}

// Calcula el "Disponible" acumulado de una categor√≠a hasta el mes actual
// Disponible = (Suma de todo lo asignado hist√≥ricamente) 
//            - (Suma de todo lo gastado hist√≥ricamente)
function calcCatAvailable(catId, currentMk) {
  let totalAssigned = 0;
  // Sumar asignaciones hasta el mes actual (inclusive)
  Object.keys(S.monthData).forEach(mk => {
    if (mk <= currentMk) {
      totalAssigned += (S.monthData[mk].assignments[catId] || 0);
    }
  });

  // Sumar gastos hasta el mes actual (inclusive)
  const totalSpent = S.txs
    .filter(t => t.cat === catId && t.type === 'expense' && t.month <= currentMk)
    .reduce((s,t) => s + t.amt, 0);

  return totalAssigned - totalSpent;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RECURRENTES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Verifica si hay recurrentes pendientes desde la √∫ltima vez hasta hoy
function checkRecurring() {
  if (!S.recurringTxs || !S.recurringTxs.length) return;
  const now = new Date();
  
  // Revisamos mes a mes desde el inicio de cada recurrente
  // para asegurar que generamos todo lo que falte.
  S.recurringTxs.forEach(r => {
    let loopDate = new Date(r.startMonth + '-01');
    const endDate = r.recEnd ? new Date(r.recEnd + '-01') : new Date(now.getFullYear()+1, 0, 1);
    
    while (loopDate <= now && loopDate <= endDate) {
      const mk = monthKey(loopDate);
      generateRecurringIfMissing(r, mk);
      // Avanzar un mes
      loopDate.setMonth(loopDate.getMonth() + 1);
    }
  });
}

function generateRecurringIfMissing(r, mk) {
  // Check si ya fue borrada manualmente
  if (S.recurringDeleted && S.recurringDeleted[r.id + '_' + mk]) return;
  // Check si ya existe
  if (S.txs.some(t => t.month === mk && t.recurringId === r.id)) return;
  
  // Check frecuencia
  const [yr, mo] = mk.split('-').map(Number);
  const [ryr, rmo] = r.startMonth.split('-').map(Number);
  const diffMonths = (yr - ryr) * 12 + (mo - rmo);
  if (diffMonths < 0) return;

  let shouldGen = false;
  if (r.freq === 'monthly') shouldGen = true;
  if (r.freq === 'weekly') shouldGen = true; // Simplificado a mensual en UI por ahora
  if (r.freq === 'bimonthly') shouldGen = diffMonths % 2 === 0;
  if (r.freq === 'quarterly') shouldGen = diffMonths % 3 === 0;
  if (r.freq === 'yearly') shouldGen = diffMonths % 12 === 0;

  if (shouldGen) {
    S.txs.push({
      id: uid(),
      month: mk,
      date: `${mk}-01`,
      pay: r.pay,
      cat: r.cat,
      amt: r.amt,
      type: r.type,
      ok: false,
      note: 'üîÑ Recurrente',
      recurringId: r.id
    });
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PERSISTENCIA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadState() {
  try {
    const raw = localStorage.getItem('ma-budget-v6');
    if (raw) return JSON.parse(raw);
  } catch(e) {}
  return JSON.parse(JSON.stringify(DEFAULT_STATE));
}
function save() {
  try { localStorage.setItem('ma-budget-v6', JSON.stringify(S)); } catch(e) {}
}
function exportJSON() {
  const blob = new Blob([JSON.stringify(S, null, 2)], { type:'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'ma-budget-'+new Date().toISOString().slice(0,10)+'.json'; a.click();
  URL.revokeObjectURL(url); showToast('Datos exportados ‚úì');
}
function importJSON(e) {
  const file = e.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const data = JSON.parse(ev.target.result);
      if (!data.groups) throw new Error();
      S = data; save(); checkRecurring(); fullRender(); showToast('Datos importados ‚úì');
    } catch(err) { showToast('Error al importar archivo'); }
    e.target.value = '';
  };
  reader.readAsText(file);
}
function confirmReset() {
  if (confirm('¬øBorrar TODO y empezar de cero?')) {
    S = JSON.parse(JSON.stringify(DEFAULT_STATE)); save(); fullRender(); showToast('Datos borrados');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDERIZADO UI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const MESES = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
const ef = n => '‚Ç¨' + Math.abs(n).toFixed(2).replace('.',',');
const efs = n => (n<0?'-':'') + ef(n);
const uid = () => '_' + Math.random().toString(36).slice(2,9);
function gc(id) { for(const g of S.groups){ const c=g.cats.find(c=>c.id===id); if(c) return c; } return null; }
function gg(id) { return S.groups.find(g=>g.id===id); }

function fullRender() {
  renderBudget(); renderTx(); renderGoals(); renderSettings();
}

function updMonth() {
  document.getElementById('month-lbl').textContent = MESES[currentMonth.getMonth()] + ' ' + currentMonth.getFullYear();
}

function chMonth(d) {
  currentMonth.setMonth(currentMonth.getMonth() + d);
  updMonth(); renderBudget(); renderTx();
}

// ‚îÄ‚îÄ C√ÅLCULOS GENERALES (Banner y Pills) ‚îÄ‚îÄ
function updateHeaderStats(mk) {
  // 1. Ingresos de ESTE mes (para la pastilla izquierda)
  const tIncMes = S.txs
    .filter(t => t.month === mk && t.type === 'income')
    .reduce((s, t) => s + t.amt, 0);

  // 2. Gastado de ESTE mes (para la pastilla derecha)
  const totalSpentMes = S.txs
    .filter(t => t.month === mk && t.type === 'expense')
    .reduce((s, t) => s + t.amt, 0);

  // 3. NUEVO: SALDO TOTAL REAL (Dinero en cuenta hasta hoy)
  // (Todos los ingresos de la historia hasta este mes) - (Todos los gastos de la historia hasta este mes)
  const allInc = S.txs.filter(t => t.type === 'income' && t.month <= mk).reduce((s,t) => s + t.amt, 0);
  const allExp = S.txs.filter(t => t.type === 'expense' && t.month <= mk).reduce((s,t) => s + t.amt, 0);
  const saldoReal = allInc - allExp;

  // 4. Para Asignar CORREGIDO: (Ingresos hasta hoy) - (Asignado hasta hoy)
  let totalAssignedHistory = 0;
  if (S.monthData) {
     Object.keys(S.monthData).forEach(mKey => {
        // Solo cuenta asignaciones del pasado y presente, no futuro
        if(mKey <= mk) {
          Object.values(S.monthData[mKey].assignments || {}).forEach(v => totalAssignedHistory += v);
        }
     });
  }
  // Usamos allInc (ingresos hasta hoy) en lugar de ingresos totales
  const toAssign = allInc - totalAssignedHistory;

  // ‚îÄ‚îÄ ACTUALIZAR EL HTML ‚îÄ‚îÄ
  
  // Pastilla Izquierda: Ingresos del mes
  const pi = document.getElementById('p-income'); 
  pi.textContent = ef(tIncMes);

  // Pastilla Central: SALDO TOTAL
  const pa = document.getElementById('p-assigned'); 
  pa.textContent = ef(saldoReal);
  pa.className = saldoReal >= 0 ? 'pill-val g' : 'pill-val r'; 

  // Pastilla Derecha: Gastado del mes
  const ps = document.getElementById('p-spent'); 
  ps.textContent = ef(totalSpentMes);
  ps.className = totalSpentMes > 0 ? 'pill-val r' : 'pill-val';

  // Banner grande: Para asignar
  const tael = document.getElementById('to-assign');
  tael.textContent = efs(toAssign);
  tael.className = toAssign < 0 ? 'deficit' : '';

  // Edad del dinero
  const age = allExp > 0 ? Math.min(Math.round(allInc/allExp * 30), 99) : 0;
  document.getElementById('age-num').textContent = age;
}

// ‚îÄ‚îÄ RENDER PRESUPUESTO ‚îÄ‚îÄ
function renderBudget() {
  const mk = monthKey(currentMonth);
  const md = getMonthData(mk);
  const body = document.getElementById('b-body');
  body.innerHTML = '';

  // Calcular gastos DEL MES para barras de progreso
  const spentThisMonth = {};
  S.txs.filter(t => t.month === mk && t.type === 'expense').forEach(t => {
    spentThisMonth[t.cat||'_none'] = (spentThisMonth[t.cat||'_none']||0) + t.amt;
  });

  S.groups.forEach(grp => {
    const wrap = document.createElement('div');
    
    // Cabecera grupo
    const gr = document.createElement('div');
    gr.className = 'g-row ' + (grp.open ? 'open' : 'closed');
    // Calc totales grupo
    let gAssigned = 0, gAvail = 0;
    grp.cats.forEach(c => {
      gAssigned += (md.assignments[c.id] || 0);
      gAvail += calcCatAvailable(c.id, mk);
    });

    gr.innerHTML = `
      <div class="g-title"><span class="chevron">‚ñæ</span>${grp.name}</div>
      <div class="g-num">${ef(gAssigned)}</div>
      <div class="g-num" style="color:${gAvail<0?'#b04a4a':'#3a3a36'}">${efs(gAvail)}</div>`;
    gr.onclick = () => { grp.open = !grp.open; save(); renderBudget(); };
    wrap.appendChild(gr);

    // Filas categor√≠as
    const crows = document.createElement('div');
    crows.className = 'c-rows' + (grp.open ? '' : ' hidden');
    
    grp.cats.forEach(cat => {
      const assigned = md.assignments[cat.id] || 0;
      const avail = calcCatAvailable(cat.id, mk);
      const spent = spentThisMonth[cat.id] || 0;
      
      // Barra de progreso
      const pct = assigned > 0 ? Math.min(spent / assigned * 100, 100) : (spent>0?100:0);
      const isOver = avail < 0;

      const row = document.createElement('div');
      row.className = 'c-row' + (isOver ? ' over' : '');
      row.innerHTML = `
        <div class="c-info">
          <span class="c-emo">${cat.emoji}</span>
          <div class="c-txt">
            <div class="c-name">${cat.name}</div>
            <div class="c-prog"><div class="c-prog-fill${isOver?' ov':''}" style="width:${pct}%"></div></div>
          </div>
        </div>
        <div class="c-assigned" id="ca-${cat.id}" onclick="startEdit('${cat.id}', event)">
          <span id="ca-t-${cat.id}">${ef(assigned)}</span>
          <input class="c-inp" id="ca-i-${cat.id}" type="number" min="0" step="0.01">
        </div>
        <div class="c-avail ${isOver?'neg':avail===0&&assigned>0?'zer':'pos'}">${efs(avail)}</div>`;
      
      const inp = row.querySelector('.c-inp');
      inp.onblur = () => endEdit(cat.id);
      inp.onkeydown = e => { if(e.key==='Enter') endEdit(cat.id); };
      crows.appendChild(row);
    });

    const addR = document.createElement('div');
    addR.className = 'add-cat'; addR.textContent = 'Ôºã A√±adir categor√≠a';
    addR.onclick = () => openSh('cat');
    crows.appendChild(addR);
    wrap.appendChild(crows);
    body.appendChild(wrap);
  });
  
  updateHeaderStats(mk);
}

// Edici√≥n inline de presupuesto
function startEdit(id, e) {
  e.stopPropagation();
  const mk = monthKey(currentMonth);
  const md = getMonthData(mk);
  const el = document.getElementById('ca-'+id);
  const inp = document.getElementById('ca-i-'+id);
  const txt = document.getElementById('ca-t-'+id);
  
  // Resetear otros
  document.querySelectorAll('.c-assigned.editing').forEach(x => x.classList.remove('editing'));
  document.querySelectorAll('.c-inp').forEach(x => x.style.display = 'none');
  document.querySelectorAll('[id^="ca-t-"]').forEach(x => x.style.display = 'block');

  el.classList.add('editing');
  txt.style.display = 'none';
  inp.style.display = 'block';
  inp.value = md.assignments[id] || 0;
  inp.focus(); inp.select();
}
function endEdit(id) {
  const inp = document.getElementById('ca-i-'+id);
  const val = parseFloat(inp.value);
  if (isNaN(val)) return cancelEdit(id);
  
  const mk = monthKey(currentMonth);
  const md = getMonthData(mk);
  md.assignments[id] = val;
  
  cancelEdit(id);
  save(); renderBudget();
}
function cancelEdit(id) {
  const el = document.getElementById('ca-'+id);
  if(el) el.classList.remove('editing');
  const inp = document.getElementById('ca-i-'+id);
  if(inp) inp.style.display = 'none';
  const txt = document.getElementById('ca-t-'+id);
  if(txt) txt.style.display = 'block';
}

// ‚îÄ‚îÄ RENDER TXS ‚îÄ‚îÄ
function renderTx() {
  const mk = monthKey(currentMonth);
  const body = document.getElementById('tx-body');
  const monthTxs = S.txs.filter(t => t.month === mk).sort((a,b) => b.date.localeCompare(a.date));

  const rcCount = S.recurringTxs ? S.recurringTxs.length : 0;
  document.getElementById('tx-rec-count').textContent = rcCount ? `üîÑ ${rcCount} activas` : '';

  if (!monthTxs.length) {
    body.innerHTML = '<div style="text-align:center;padding:50px 20px;color:#aaa;font-size:13px">No hay movimientos este mes.<br>Pulsa + para a√±adir.</div>';
    return;
  }

  body.innerHTML = '';
  monthTxs.forEach(tx => {
    const cat = tx.cat ? gc(tx.cat) : null;
    const dateObj = new Date(tx.date);
    const dateStr = dateObj.toLocaleDateString('es-ES', { day:'numeric', month:'short' });
    const icon = cat ? cat.emoji : (tx.type==='income'?'üí∞':'üí∏');
    
    const wrap = document.createElement('div');
    wrap.className = 'tx-swipe-wrap';
    const delBg = document.createElement('div'); delBg.className='tx-del-bg'; delBg.innerHTML='<span>üóë</span>Borrar';
    
    const item = document.createElement('div');
    item.className = 'tx-item';
    item.innerHTML = `
      <div class="tx-icon">${icon}${tx.recurringId?'<div class="tx-recurring-dot">R</div>':''}</div>
      <div class="tx-mid">
        <div class="tx-payer">${tx.pay}</div>
        <div class="tx-sub">${cat?cat.name:(tx.type==='income'?'Ingreso':'Sin categor√≠a')} ¬∑ ${dateStr}</div>
      </div>
      <div class="tx-right">
        <div class="tx-amt ${tx.type}">${tx.type==='income'?'+':'-'}${ef(tx.amt)}</div>
      </div>`;
    item.onclick = () => openEditTx(tx.id);
    
    wrap.appendChild(delBg); wrap.appendChild(item);
    body.appendChild(wrap);
    initSwipe(item, wrap, tx.id);
  });
}

function initSwipe(item, wrap, id) {
  let startX=0, curX=0, swiping=false;
  item.addEventListener('touchstart', e => { startX=e.touches[0].clientX; swiping=true; item.style.transition='none'; }, {passive:true});
  item.addEventListener('touchmove', e => {
    if(!swiping) return;
    curX = e.touches[0].clientX - startX;
    if(curX>0) curX=0;
    item.style.transform=`translateX(${curX}px)`;
  }, {passive:true});
  item.addEventListener('touchend', () => {
    swiping=false; item.style.transition='transform .2s';
    if(curX < -80) {
      item.style.transform = `translateX(-100%)`;
      setTimeout(() => {
        S.txs = S.txs.filter(t=>t.id!==id);
        save(); renderBudget(); renderTx(); showToast('Transacci√≥n eliminada');
      }, 200);
    } else {
      item.style.transform='translateX(0)';
    }
  });
}

// ‚îÄ‚îÄ ACCIONES TX ‚îÄ‚îÄ
function openEditTx(id) {
  const tx = S.txs.find(t=>t.id===id); if(!tx) return;
  editingTxId = id;
  document.getElementById('tx-sh-title').textContent = 'Editar transacci√≥n';
  document.getElementById('tx-save-btn').textContent = 'Guardar cambios';
  document.getElementById('tx-del-btn').style.display = 'block';
  document.getElementById('f-date').value = tx.date;
  document.getElementById('f-amt').value = tx.amt;
  document.getElementById('f-pay').value = tx.pay;
  document.getElementById('f-note').value = tx.note||'';
  setType(tx.type);
  populateCatSelect();
  document.getElementById('f-cat').value = tx.cat||'';
  document.getElementById('f-rec-toggle').checked = false;
  document.getElementById('rec-fields').classList.remove('on');
  openSh('tx');
}

function saveTx() {
  const amt = parseFloat(document.getElementById('f-amt').value)||0;
  const pay = document.getElementById('f-pay').value.trim();
  const dateVal = document.getElementById('f-date').value;
  if (!pay || !dateVal || amt<=0) { showToast('Faltan datos'); return; }

  const cat = txType==='income' ? null : (document.getElementById('f-cat').value||null);
  const txMonth = dateVal.slice(0,7);
  
  if (editingTxId) {
    const tx = S.txs.find(t=>t.id===editingTxId);
    if(tx) { tx.date=dateVal; tx.month=txMonth; tx.pay=pay; tx.cat=cat; tx.amt=amt; tx.type=txType; tx.note=document.getElementById('f-note').value; }
    editingTxId = null;
  } else {
    const isRec = document.getElementById('f-rec-toggle').checked;
    const newTx = { id:uid(), month:txMonth, date:dateVal, pay, cat, amt, type:txType, ok:true, note:document.getElementById('f-note').value };
    S.txs.push(newTx);
    
    if (isRec) {
      const r = {
        id:uid(), pay, cat, amt, type:txType, freq:document.getElementById('f-rec-freq').value,
        recEnd:document.getElementById('f-rec-end').value||null, startMonth:txMonth,
        emoji: cat ? (gc(cat)?.emoji) : 'üîÑ'
      };
      if(!S.recurringTxs) S.recurringTxs=[];
      S.recurringTxs.push(r);
      newTx.recurringId = r.id;
    }
  }
  save(); closeSh('tx'); renderBudget(); renderTx(); showToast('Guardado');
}

function deleteTx() {
  if(!editingTxId) return;
  S.txs = S.txs.filter(t=>t.id!==editingTxId);
  editingTxId = null;
  save(); closeSh('tx'); renderBudget(); renderTx(); showToast('Eliminado');
}

// ‚îÄ‚îÄ CATEGOR√çAS ‚îÄ‚îÄ
function saveCat() {
  const gId = document.getElementById('c-grp').value;
  const name = document.getElementById('c-nm').value.trim();
  const emo = document.getElementById('c-emo').value || 'üìå';
  if(!name) return;
  
  const nc = { id:uid(), emoji:emo, name };
  if(gId) {
    const g = gg(gId); if(g) g.cats.push(nc);
  } else {
    const gn = document.getElementById('c-newg').value.trim() || 'Nuevo grupo';
    S.groups.push({ id:uid(), name:gn, open:true, cats:[nc] });
  }
  save(); closeSh('cat'); renderBudget(); showToast('Categor√≠a creada');
}

// ‚îÄ‚îÄ HANDLERS UI VARIOS ‚îÄ‚îÄ
function showPanel(id) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('on'));
  document.querySelectorAll('.ntab').forEach(t => t.classList.remove('on'));
  document.getElementById('panel-'+id).classList.add('on');
  document.getElementById('tab-'+id).classList.add('on');
  document.getElementById('fab').style.display = (id==='tx'||id==='budget') ? 'flex' : 'none';
  if(id==='tx') renderTx();
  if(id==='rep') renderRep();
}

function openSh(id) {
  if (id==='tx') {
    editingTxId = null;
    document.getElementById('tx-sh-title').textContent='Nueva transacci√≥n';
    document.getElementById('tx-save-btn').textContent='Guardar';
    document.getElementById('tx-del-btn').style.display='none';
    document.getElementById('f-date').value = new Date().toISOString().split('T')[0];
    document.getElementById('f-amt').value = '';
    document.getElementById('f-pay').value = '';
    populateCatSelect();
    setType('expense');
  }
  if (id==='cat') {
    const sel = document.getElementById('c-grp'); sel.innerHTML='<option value="">‚Äî Nuevo grupo ‚Äî</option>';
    S.groups.forEach(g => { const o = document.createElement('option'); o.value=g.id; o.textContent=g.name; sel.appendChild(o); });
    sel.onchange = () => document.getElementById('c-newg-wrap').style.display = sel.value ? 'none':'block';
    document.getElementById('c-newg-wrap').style.display='block';
    document.getElementById('c-nm').value=''; document.getElementById('c-emo').value=''; document.getElementById('c-newg').value='';
  }
  if (id==='recurring') renderRecSheet();
  document.getElementById('ov-'+id).classList.add('open');
}

function closeSh(id) { document.getElementById('ov-'+id).classList.remove('open'); }
function setType(t) {
  txType=t;
  document.getElementById('ch-exp').className='tchip'+(t==='expense'?' ae':'');
  document.getElementById('ch-inc').className='tchip'+(t==='income'?' ai':'');
  document.getElementById('f-cat-fg').style.display = t==='income'?'none':'block';
}
function populateCatSelect() {
  const sel = document.getElementById('f-cat'); sel.innerHTML='<option value="">Sin categor√≠a</option>';
  S.groups.forEach(g=>{
    const og=document.createElement('optgroup'); og.label=g.name;
    g.cats.forEach(c=>{ const o=document.createElement('option'); o.value=c.id; o.textContent=c.emoji+' '+c.name; og.appendChild(o); });
    sel.appendChild(og);
  });
}
function toggleRecFields() {
  document.getElementById('rec-fields').classList.toggle('on', document.getElementById('f-rec-toggle').checked);
}
function showToast(msg) {
  const t = document.getElementById('toast'); t.textContent=msg; t.classList.add('on');
  setTimeout(()=>t.classList.remove('on'), 2500);
}

// ‚îÄ‚îÄ SHEET RECURRENTES ‚îÄ‚îÄ
function renderRecSheet() {
  const body = document.getElementById('rec-sheet-body');
  if(!S.recurringTxs || !S.recurringTxs.length) {
    body.innerHTML = '<div style="text-align:center;color:#aaa;padding:20px;">No hay recurrentes</div>'; return;
  }
  body.innerHTML = '';
  S.recurringTxs.forEach(r => {
    const row = document.createElement('div');
    row.style.cssText = 'display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid #eee;align-items:center';
    row.innerHTML = `
      <div>
        <div style="font-size:14px">${r.emoji||'üîÑ'} ${r.pay}</div>
        <div style="font-size:11px;color:#888">${r.freq} ¬∑ ${ef(r.amt)}</div>
      </div>
      <button onclick="delRec('${r.id}')" style="color:#b04a4a;background:none;border:none;font-size:12px;padding:6px">Eliminar</button>`;
    body.appendChild(row);
  });
}
function delRec(id) {
  if(!confirm('¬øDejar de generar esta transacci√≥n?')) return;
  S.recurringTxs = S.recurringTxs.filter(r=>r.id!==id);
  save(); renderRecSheet(); showToast('Recurrente eliminada');
}

// ‚îÄ‚îÄ INFORMES Y METAS ‚îÄ‚îÄ
function renderRep() {
  const body = document.getElementById('rep-body');
  // Simple stats por ahora
  const mk = monthKey(currentMonth);
  const inc = S.txs.filter(t=>t.month===mk && t.type==='income').reduce((s,t)=>s+t.amt,0);
  const exp = S.txs.filter(t=>t.month===mk && t.type==='expense').reduce((s,t)=>s+t.amt,0);
  
  body.innerHTML = `
    <div class="rep-card">
      <div class="rep-ttl">Este Mes</div>
      <div class="ie-row2">
        <div class="ie-box2"><div class="ie-lbl2">Ingresado</div><div class="ie-v inc">${ef(inc)}</div></div>
        <div class="ie-box2"><div class="ie-lbl2">Gastado</div><div class="ie-v exp">${ef(exp)}</div></div>
      </div>
    </div>`;
}
function renderGoals() {
  const body = document.getElementById('g-body');
  if(!S.goals.length) { body.innerHTML='<div style="text-align:center;color:#aaa;padding:20px">No hay metas</div>'; return; }
  body.innerHTML = S.goals.map(g => {
    const pct = Math.min(g.saved/g.target*100, 100);
    return `<div class="goal-card" onclick="openSh('goal')">
      <div class="goal-stripe ${g.type}"></div>
      <div class="goal-name">${g.emoji} ${g.name}</div>
      <div class="goal-trk"><div class="goal-fill ${g.type}" style="width:${pct}%"></div></div>
      <div class="goal-stats2"><span class="goal-sv">${ef(g.saved)}</span><span class="goal-tgt">/ ${ef(g.target)}</span></div>
    </div>`
  }).join('');
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
['tx','cat','goal','income','group','editcat','recurring'].forEach(id => {
  const ov = document.getElementById('ov-'+id);
  if(ov) ov.addEventListener('click', e => { if(e.target===ov) closeSh(id); });
});

checkRecurring();
updMonth();
renderBudget();
renderTx();

</script>
</body>
</html>

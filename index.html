<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Èñì Ma Budget - Zen Edition</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@200;900&family=Noto+Sans+JP:wght@100;300;400&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

:root {
  --bg: #ffffff;
  --card: #ffffff;
  --primary: #1a1a1a; /* Negro Tinta */
  --accent: #bc002d;  /* Rojo Imperial */
  --text: #1a1a1a;
  --text-light: #888888;
  --danger: #bc002d;
  --secondary: #4a4a4a;
  --safe-area-bottom: env(safe-area-inset-bottom, 0px);
}

html, body { 
  height: 100dvh; 
  font-family:'Noto Sans JP', sans-serif; 
  font-size:14px; 
  color:var(--text); 
  background:var(--bg); 
  overflow:hidden; 
}

#app { display:flex; flex-direction:column; height:100%; position: relative; }

/* ‚îÄ‚îÄ NUEVO HEADER JAPON√âS ‚îÄ‚îÄ */
#header { 
  padding: clamp(50px, 8vh, 70px) 25px 20px;
  background: var(--bg);
  position: relative;
  border-bottom: 1px solid #f0f0f0;
}

.shodo-title {
  writing-mode: vertical-rl;
  font-family: 'Noto Serif JP', serif;
  font-weight: 900;
  font-size: 3.5rem;
  color: var(--primary);
  line-height: 1;
  float: left;
  margin-right: 15px;
  letter-spacing: -5px;
}

.hanko {
  display: inline-block;
  border: 2px solid var(--accent);
  color: var(--accent);
  padding: 2px 4px;
  font-weight: 900;
  font-size: 10px;
  margin-bottom: 15px;
  text-transform: uppercase;
}

.header-meta {
  display: flex;
  flex-direction: column;
  justify-content: flex-end;
  height: 140px; /* Alineado con el texto vertical */
}

.sub-lang {
  font-size: 10px;
  letter-spacing: 0.2em;
  color: var(--text-light);
  text-transform: uppercase;
  margin-bottom: 10px;
}

#month-lbl {
  font-family: 'Noto Serif JP', serif;
  font-size: 1.4rem;
  font-weight: 200;
  text-transform: capitalize;
  border-bottom: 1px solid var(--primary);
  padding-bottom: 5px;
  display: inline-block;
  margin-bottom: 15px;
}

/* ‚îÄ‚îÄ BANNER DISPONIBLE (ESTILO ENSO) ‚îÄ‚îÄ */
#banner { 
  padding: 20px 25px; 
  background: #fdfdfd; 
  display: flex; 
  align-items: center; 
  justify-content: space-between;
}

#to-assign { 
  font-family: 'Noto Serif JP', serif;
  font-size: 32px; 
  font-weight: 900; 
  color: var(--primary);
}

#to-assign.deficit { color: var(--accent); }

.age-box { text-align: right; }
#age-num { font-size: 28px; font-weight: 100; color: var(--accent); }
.age-lbl { font-size: 8px; letter-spacing: 1px; color: var(--text-light); text-transform: uppercase; }

/* ‚îÄ‚îÄ SCROLL & TABLAS ‚îÄ‚îÄ */
#scroll { flex:1; overflow-y:auto; padding-bottom:100px; }

.g-row { 
  padding: 25px 25px 10px; 
  font-size: 11px; 
  letter-spacing: 2px; 
  text-transform: uppercase; 
  color: var(--text-light);
  border-bottom: 2px solid var(--primary);
  margin: 0 25px;
  display: flex;
  justify-content: space-between;
}

.c-row { 
  display: grid; 
  grid-template-columns: 1fr 80px 80px; 
  padding: 18px 25px; 
  align-items: center;
  transition: background 0.3s;
}

.c-name { font-size: 15px; font-weight: 400; color: var(--text); }
.c-assigned { font-family: 'Noto Serif JP'; font-size: 16px; text-align: right; color: #888; }
.c-avail { font-family: 'Noto Serif JP'; font-size: 16px; font-weight: 900; text-align: right; }
.c-avail.pos { color: var(--primary); }
.c-avail.neg { color: var(--accent); }

/* ‚îÄ‚îÄ PILLS / RESUMEN ‚îÄ‚îÄ */
#pills { 
  display: flex; 
  gap: 20px; 
  padding: 10px 25px;
  margin-top: 10px;
}
.pill { flex: 1; }
.pill-lbl { font-size: 8px; text-transform: uppercase; color: var(--text-light); letter-spacing: 1px; }
.pill-val { font-family: 'Noto Serif JP'; font-size: 14px; display: block; }

/* ‚îÄ‚îÄ NAVEGACI√ìN TINTA ‚îÄ‚îÄ */
#nav { 
  position:fixed; bottom:0; left:0; right:0; 
  background: var(--primary); 
  display:flex; 
  padding-bottom:var(--safe-area-bottom);
}
.ntab { 
  flex:1; padding: 15px 0; 
  background:none; border:none; 
  color:rgba(255,255,255,0.4); 
  display:flex; flex-direction:column; align-items:center; gap:4px;
}
.ntab.on { color: var(--bg); }
.nicon { font-size: 18px; }
.nlbl { font-size: 8px; text-transform: uppercase; letter-spacing: 1px; }

/* ‚îÄ‚îÄ BOT√ìN FLOTANTE ‚îÄ‚îÄ */
#fab { 
  position:fixed; right:25px; bottom: 80px; 
  width:55px; height:55px; 
  background:var(--accent); 
  border-radius:0; /* Cuadrado como un sello */
  display:flex; align-items:center; justify-content:center; 
  color:#fff; font-size:24px; border:none;
  box-shadow: 4px 4px 0px rgba(0,0,0,0.1);
}

/* Modales */
.sheet { border-radius: 0; border-top: 5px solid var(--primary); }
.sbtn { border-radius: 0; background: var(--primary); text-transform: uppercase; letter-spacing: 2px; font-size: 12px; }

</style>
</head>
<body>

<div id="app">
  <header id="header">
    <div class="shodo-title">ÂÆ∂Ë®àÁ∞ø</div>
    <div class="header-meta">
      <div class="hanko">MA</div>
      <div class="sub-lang">Ingresos y Gastos</div>
      <div id="month-lbl">Cargando...</div>
      <div style="display: flex; gap: 10px;">
        <button onclick="changeMonth(-1)" style="background:none; border:none; font-size:20px;">‚Üê</button>
        <button onclick="changeMonth(1)" style="background:none; border:none; font-size:20px;">‚Üí</button>
      </div>
    </div>

    <div id="pills">
      <div class="pill"><span class="pill-lbl">Entradas</span><span class="pill-val" id="p-income">‚Ç¨0</span></div>
      <div class="pill"><span class="pill-lbl">Asignado</span><span class="pill-val" id="p-assigned">‚Ç¨0</span></div>
      <div class="pill"><span class="pill-lbl">Gastos</span><span class="pill-val" id="p-spent">‚Ç¨0</span></div>
    </div>
  </header>

  <div id="banner">
    <div>
      <div class="age-lbl">Presupuesto Disponible</div>
      <div id="to-assign">‚Ç¨0,00</div>
    </div>
    <div class="age-box">
        <div id="age-num">0</div>
        <div class="age-lbl">D√≠as de Vida</div>
    </div>
  </div>

  <div id="scroll">
    <div class="panel on" id="panel-budget">
      <div id="budget-content"></div>
    </div>
    <div class="panel" id="panel-tx"><div id="tx-content"></div></div>
    <div class="panel" id="panel-goals"><div id="goals-content" style="padding:20px"></div></div>
    <div class="panel" id="panel-rep"><div id="rep-content" style="padding:20px"></div></div>
    <div class="panel" id="panel-settings">
        <div style="padding:30px">
            <button class="sbtn" style="width:100%; padding:15px; color:white; margin-bottom:10px" onclick="exportData()">Exportar JSON</button>
            <button class="sbtn" style="width:100%; padding:15px; color:white; background:var(--accent)" onclick="resetApp()">Reiniciar App</button>
        </div>
    </div>
  </div>

  <button id="fab" onclick="openSheet('tx')">Ôºã</button>

  <nav id="nav">
    <button class="ntab on" id="tab-budget" onclick="showPanel('budget')"><span class="nicon">‰Ωì</span><span class="nlbl">Plan</span></button>
    <button class="ntab" id="tab-tx" onclick="showPanel('tx')"><span class="nicon">Èå≤</span><span class="nlbl">Movs</span></button>
    <button class="ntab" id="tab-goals" onclick="showPanel('goals')"><span class="nicon">ÁöÑ</span><span class="nlbl">Metas</span></button>
    <button class="ntab" id="tab-rep" onclick="showPanel('rep')"><span class="nicon">Âõ≥</span><span class="nlbl">Stats</span></button>
    <button class="ntab" id="tab-settings" onclick="showPanel('settings')"><span class="nicon">Ë®≠</span><span class="nlbl">Ajustes</span></button>
  </nav>
</div>

<div class="overlay" id="ov-tx">
    <div class="sheet">
      <div class="sh-handle"></div>
      <div class="sh-title" style="font-family:'Noto Serif JP'">Nueva Transacci√≥n</div>
      <div style="display:flex; gap:10px; margin-bottom:20px;">
        <button id="type-exp" class="sbtn" style="flex:1; color:white" onclick="setTxType('expense')">Gasto</button>
        <button id="type-inc" class="sbtn" style="flex:1; background:#eee; color:black" onclick="setTxType('income')">Ingreso</button>
      </div>
      <input type="number" id="f-amt" class="finp" placeholder="Importe ‚Ç¨" style="font-size:30px; margin-bottom:15px">
      <input type="text" id="f-payee" class="finp" placeholder="Concepto" style="margin-bottom:15px">
      <input type="date" id="f-date" class="finp" style="margin-bottom:15px">
      <select id="f-cat" class="finp" style="margin-bottom:20px"></select>
      <button class="sbtn" style="width:100%; padding:18px; color:white" onclick="saveTx()">Confirmar Registro</button>
    </div>
</div>

<div id="toast"></div>

<script>
// [Aqu√≠ va toda tu l√≥gica original de JS sin cambios sustanciales]
// He ajustado ligeramente renderBudget para que use las nuevas clases CSS
let DB = { groups: [], txs: [], assignments: {}, goals: [], settings: { currency: '‚Ç¨' } };
let currentMonth = new Date();
let activeTxId = null;
let currentTxType = 'expense';

function init() {
  const saved = localStorage.getItem('ma_budget_pro_v1');
  if (saved) { DB = JSON.parse(saved); } 
  else {
    DB.groups = [
      { id: 'g1', name: 'Esenciales', cats: [{ id: 'c1', name: 'Vivienda', emoji: 'üè†' }, { id: 'c2', name: 'Comida', emoji: 'üç±' }]},
      { id: 'g2', name: 'Estilo de Vida', cats: [{ id: 'c3', name: 'Ocio', emoji: 'üé¨' }]}
    ];
  }
  updateUI();
}

function updateUI() {
  document.getElementById('month-lbl').innerText = currentMonth.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
  const toAssignVal = getToAssign(currentMonth);
  const toAssignEl = document.getElementById('to-assign');
  toAssignEl.innerText = formatEuro(toAssignVal);
  toAssignEl.className = toAssignVal < 0 ? 'deficit' : '';
  renderBudget();
  renderTxs();
  updatePills();
  save();
}

function renderBudget() {
  const mKey = getMonthKey(currentMonth);
  const container = document.getElementById('budget-content');
  container.innerHTML = '';
  if (!DB.assignments[mKey]) DB.assignments[mKey] = {};

  DB.groups.forEach(group => {
    const groupDiv = document.createElement('div');
    const catsHtml = group.cats.map(cat => {
      const assigned = DB.assignments[mKey][cat.id] || 0;
      const avail = getAvailable(cat.id, currentMonth);
      return `
        <div class="c-row">
          <div class="c-info">
            <div class="c-name">${cat.emoji} ${cat.name}</div>
          </div>
          <div class="c-assigned" onclick="editAssigned('${cat.id}', this)">
            <span class="val-txt">${formatEuro(assigned)}</span>
            <input type="number" class="c-inp" style="display:none; width:60px" value="${assigned}" onblur="saveAssigned('${cat.id}', this)">
          </div>
          <div class="c-avail ${avail >= 0 ? 'pos' : 'neg'}">${formatEuro(avail)}</div>
        </div>
      `;
    }).join('');

    groupDiv.innerHTML = `<div class="g-row"><span>${group.name}</span><span>Asignado / Disp.</span></div>${catsHtml}`;
    container.appendChild(groupDiv);
  });
}

// ... (Resto de funciones: getMonthKey, getAvailable, getToAssign, save, etc. son las de tu c√≥digo anterior)
function getMonthKey(date) { return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`; }
function formatEuro(n) { return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(n); }
function getAvailable(catId, monthDate) {
  let totalAssigned = 0, totalSpent = 0;
  const currentKey = getMonthKey(monthDate);
  Object.keys(DB.assignments).forEach(mKey => { if (mKey <= currentKey) totalAssigned += (DB.assignments[mKey][catId] || 0); });
  DB.txs.forEach(t => { if (t.cat === catId && t.type === 'expense' && t.date.substring(0, 7) <= currentKey) totalSpent += t.amt; });
  return totalAssigned - totalSpent;
}
function getToAssign(monthDate) {
  const currentKey = getMonthKey(monthDate);
  let totalIncome = 0, totalAssigned = 0;
  DB.txs.forEach(t => { if (t.type === 'income' && t.date.substring(0, 7) <= currentKey) totalIncome += t.amt; });
  Object.keys(DB.assignments).forEach(mKey => { if (mKey <= currentKey) Object.values(DB.assignments[mKey]).forEach(val => totalAssigned += val); });
  return totalIncome - totalAssigned;
}
function save() { localStorage.setItem('ma_budget_pro_v1', JSON.stringify(DB)); }
function changeMonth(dir) { currentMonth.setMonth(currentMonth.getMonth() + dir); updateUI(); }
function showPanel(id) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('on'));
  document.querySelectorAll('.ntab').forEach(t => t.classList.remove('on'));
  document.getElementById('panel-' + id).classList.add('on');
  document.getElementById('tab-' + id).classList.add('on');
}
function openSheet(id) { 
    if(id === 'tx') {
        const sel = document.getElementById('f-cat');
        sel.innerHTML = DB.groups.map(g => `<optgroup label="${g.name}">${g.cats.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}</optgroup>`).join('');
    }
    document.getElementById('ov-' + id).classList.add('open'); 
}
function saveTx() {
    const amt = parseFloat(document.getElementById('f-amt').value);
    const payee = document.getElementById('f-payee').value;
    const date = document.getElementById('f-date').value;
    const cat = document.getElementById('f-cat').value;
    if(!amt || !date) return;
    DB.txs.push({ id: Date.now().toString(), amt, payee, date, cat, type: currentTxType });
    document.getElementById('ov-tx').classList.remove('open');
    updateUI();
}
function setTxType(t) { currentTxType = t; }
function editAssigned(id, el) {
    const inp = el.querySelector('input');
    const txt = el.querySelector('span');
    txt.style.display = 'none';
    inp.style.display = 'inline-block';
    inp.focus();
}
function saveAssigned(id, inp) {
    const mKey = getMonthKey(currentMonth);
    if(!DB.assignments[mKey]) DB.assignments[mKey] = {};
    DB.assignments[mKey][id] = parseFloat(inp.value) || 0;
    updateUI();
}
function updatePills() {
    const mKey = getMonthKey(currentMonth);
    const inc = DB.txs.filter(t => t.type === 'income' && t.date.startsWith(mKey)).reduce((s,t)=>s+t.amt, 0);
    const exp = DB.txs.filter(t => t.type === 'expense' && t.date.startsWith(mKey)).reduce((s,t)=>s+t.amt, 0);
    const ass = Object.values(DB.assignments[mKey] || {}).reduce((s,v)=>s+v, 0);
    document.getElementById('p-income').innerText = formatEuro(inc);
    document.getElementById('p-spent').innerText = formatEuro(exp);
    document.getElementById('p-assigned').innerText = formatEuro(ass);
}
function renderTxs() { /* Similar a tu l√≥gica pero en contenedor nuevo */ }

window.onload = init;
</script>
</body>
</html>

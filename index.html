<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>é–“ Ma Budget</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500&family=Noto+Sans+JP:wght@300;400&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
:root {
  --bg: #f0ece3;
  --card: #fdfbf7;
  --primary: #4a6741;
  --accent: #c4a46a;
  --text: #1a1a18;
  --text-light: #888884;
  --danger: #b04a4a;
  --secondary: #3a6878;
  --safe-area-bottom: env(safe-area-inset-bottom, 0px);
}

html, body { height:100%; font-family:'Noto Sans JP',sans-serif; font-size:14px; font-weight:300; color:var(--text); background:var(--bg); overflow:hidden; -webkit-font-smoothing:antialiased; }
#app { display:flex; flex-direction:column; height:100%; position: relative; }

/* â”€â”€ HEADER â”€â”€ */
#header { background-color:#1a1a18; flex-shrink:0; padding-top: clamp(40px, 8vh, 60px); transition: all 0.3s ease; }
#top-bar { display:flex; align-items:center; justify-content:space-between; padding:0 18px 16px; gap:8px; }
.logo { font-family:'Cormorant Garamond',serif; font-size:22px; font-weight:300; color:var(--accent); letter-spacing:.1em; cursor:pointer; }
.month-nav { display:flex; align-items:center; background-color:rgba(255,255,255,.12); border-radius:99px; overflow:hidden; }
.mnbtn { width:36px; height:36px; background:none; border:none; color:rgba(255,255,255,.8); font-size:18px; cursor:pointer; display:flex; align-items:center; justify-content:center; }
#month-lbl { color:#fff; font-family:'Cormorant Garamond',serif; font-size:15px; letter-spacing:.05em; min-width:115px; text-align:center; }

#pills { display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; padding:0 18px 18px; }
.pill { background-color:rgba(255,255,255,.10); border-radius:12px; padding:10px 8px; text-align:center; }
.pill-lbl { display:block; font-size:9px; letter-spacing:.13em; text-transform:uppercase; color:rgba(255,255,255,.45); margin-bottom:4px; }
.pill-val { font-family:'Cormorant Garamond',serif; font-size:18px; color:#fff; }
.pill-val.g { color:#8fcc7a; } .pill-val.a { color:#ddb96a; } .pill-val.r { color:#d47a7a; }

/* â”€â”€ BANNER â”€â”€ */
#banner { background-color:var(--primary); display:flex; align-items:center; justify-content:space-between; padding:14px 18px; flex-shrink:0; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 10; }
.banner-lbl { font-size:9px; letter-spacing:.14em; text-transform:uppercase; color:rgba(255,255,255,.6); margin-bottom:2px; }
#to-assign { font-family:'Cormorant Garamond',serif; font-size:28px; font-weight:300; color:#c8e8b0; cursor:pointer; border-bottom:1px dashed rgba(255,255,255,.3); }
#to-assign.deficit { color:#f0b0b0; }
.age-box { background-color:rgba(0,0,0,.20); border-radius:20px; padding:6px 16px; text-align:center; cursor:pointer; }
#age-num { font-family:'Cormorant Garamond',serif; font-size:24px; line-height:1; color:#fff; }
.age-lbl { font-size:8px; letter-spacing:.1em; text-transform:uppercase; color:rgba(255,255,255,.5); }

/* â”€â”€ SCROLL & PANELS â”€â”€ */
#scroll { flex:1; overflow-y:auto; overflow-x:hidden; -webkit-overflow-scrolling:touch; padding-bottom:100px; }
.panel { display:none; animation: fadeIn 0.3s ease; } 
.panel.on { display:block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

/* â”€â”€ BUDGET TABLE â”€â”€ */
#col-hdr { display:grid; grid-template-columns:1fr 90px 90px; padding:12px 18px 10px; position:sticky; top:0; z-index:9; background-color:var(--bg); border-bottom:1px solid rgba(0,0,0,.08); }
.ch { font-size:9px; letter-spacing:.13em; text-transform:uppercase; color:var(--text-light); } .ch:not(:first-child) { text-align:right; }

.g-row { display:grid; grid-template-columns:1fr 90px 90px; padding:12px 18px; background-color:#e6e2d8; border-top:1px solid rgba(0,0,0,.07); cursor:pointer; align-items:center; }
.g-title { display:flex; align-items:center; gap:8px; font-size:10px; letter-spacing:.12em; text-transform:uppercase; color:#3a3a36; font-weight:500; }
.chevron { font-size:10px; color:var(--text-light); transition:transform .2s; } .g-row.closed .chevron { transform:rotate(-90deg); }
.g-num { font-family:'Cormorant Garamond',serif; font-size:16px; color:#3a3a36; text-align:right; }

.c-rows.hidden { display:none; }
.c-row { display:grid; grid-template-columns:1fr 90px 90px; padding:14px 18px 14px 30px; background-color:var(--card); border-top:1px solid rgba(0,0,0,.04); align-items:center; }
.c-row.over { border-left:4px solid var(--danger); padding-left:26px; }
.c-info { display:flex; align-items:center; gap:10px; min-width:0; }
.c-emo { font-size:16px; flex-shrink:0; }
.c-txt { min-width:0; flex:1; }
.c-name { font-size:14px; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.c-prog { height:3px; background:rgba(0,0,0,.08); border-radius:2px; margin-top:5px; overflow:hidden; }
.c-prog-fill { height:100%; background-color:var(--primary); border-radius:2px; transition: width 0.4s ease; }
.c-prog-fill.ov { background-color:var(--danger); }
.c-assigned { font-family:'Cormorant Garamond',serif; font-size:18px; color:#3a3a36; text-align:right; cursor:text; padding:4px 6px; border-radius:6px; position:relative; min-height: 28px; }
.c-assigned.editing { background-color:#e2ecd9; outline:1.5px solid var(--primary); z-index: 5; }
.c-inp { position:absolute; inset:0; background:transparent; border:none; outline:none; font-family:'Cormorant Garamond',serif; font-size:18px; text-align:right; color:var(--text); padding:0 6px; display:none; width:100%; }
.c-avail { font-family:'Cormorant Garamond',serif; font-size:18px; text-align:right; padding-right:2px; font-weight: 400; }
.c-avail.pos { color:var(--primary); } .c-avail.neg { color:var(--danger); } .c-avail.zer { color:#aaa; }
.add-cat { padding:12px 18px 12px 30px; background-color:var(--card); border-top:1px solid rgba(0,0,0,.04); color:var(--primary); font-size:12px; letter-spacing:.04em; cursor:pointer; font-weight: 400; }

/* â”€â”€ MOVIMIENTOS â”€â”€ */
.tx-sticky { padding:14px 18px 10px; font-size:9px; letter-spacing:.13em; text-transform:uppercase; color:var(--text-light); background-color:var(--bg); position:sticky; top:0; z-index:8; border-bottom:1px solid rgba(0,0,0,.07); display:flex; justify-content:space-between; align-items:center; }
.tx-item { display:flex; align-items:center; padding:15px 18px; background-color:var(--card); border-top:1px solid rgba(0,0,0,.04); gap:14px; cursor:pointer; transition:background .15s; }
.tx-item:active { background-color:#f0ece3; }
.tx-icon { width:44px; height:44px; border-radius:50%; background-color:#e6e2d8; display:flex; align-items:center; justify-content:center; font-size:18px; flex-shrink:0; position:relative; }
.tx-dot { position:absolute; top:0; right:0; width:12px; height:12px; background-color:var(--accent); border-radius:50%; border:2px solid var(--card); }
.tx-mid { flex:1; min-width:0; }
.tx-payer { font-size:15px; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-weight: 400; }
.tx-sub { font-size:12px; color:var(--text-light); margin-top:2px; }
.tx-amt { font-family:'Cormorant Garamond',serif; font-size:19px; font-weight: 400; }
.tx-amt.inc { color:var(--primary); } 

/* â”€â”€ FAB & NAV â”€â”€ */
#fab { position:fixed; right:20px; bottom: calc(85px + var(--safe-area-bottom)); width:56px; height:56px; background-color:var(--primary); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:28px; color:#fff; cursor:pointer; border:none; z-index:100; box-shadow:0 6px 20px rgba(74,103,65,0.4); transition: transform 0.2s; }
#fab:active { transform: scale(0.9); }

#nav { position:fixed; bottom:0; left:0; right:0; background-color:#1a1a18; display:flex; z-index:110; padding-bottom:var(--safe-area-bottom); border-top:1px solid rgba(255,255,255,.07); }
.ntab { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:12px 4px 14px; gap:4px; background:none; border:none; color:rgba(255,255,255,.3); cursor:pointer; transition:all 0.2s; }
.ntab.on { color:var(--accent); }
.nicon { font-size:22px; } .nlbl { font-size:9px; letter-spacing:.1em; text-transform:uppercase; }

/* â”€â”€ MODALES / SHEETS â”€â”€ */
.overlay { position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:200; display:flex; align-items:flex-end; opacity:0; pointer-events:none; transition:opacity .3s cubic-bezier(0.4, 0, 0.2, 1); }
.overlay.open { opacity:1; pointer-events:all; }
.sheet { background-color:var(--card); border-radius:24px 24px 0 0; width:100%; padding:20px 20px calc(30px + var(--safe-area-bottom)); transform:translateY(100%); transition:transform .3s cubic-bezier(0.4, 0, 0.2, 1); max-height:92vh; overflow-y:auto; }
.overlay.open .sheet { transform:translateY(0); }
.sh-handle { width:40px; height:5px; background-color:#d0ccc4; border-radius:3px; margin:0 auto 24px; }
.sh-title { font-family:'Cormorant Garamond',serif; font-size:26px; font-weight:300; margin-bottom:20px; }

.fg { margin-bottom:16px; }
.flbl { font-size:10px; letter-spacing:.11em; text-transform:uppercase; color:var(--text-light); display:block; margin-bottom:6px; font-weight: 500; }
.finp { width:100%; background-color:#e6e2d8; border:2px solid transparent; border-radius:12px; padding:13px 15px; font-family:'Noto Sans JP',sans-serif; font-size:15px; color:var(--text); outline:none; transition: all 0.2s; }
.finp:focus { border-color:var(--primary); background-color:#fff; box-shadow: 0 0 0 4px rgba(74,103,65,0.1); }
.sbtn { width:100%; background-color:var(--primary); color:#fff; border:none; border-radius:14px; padding:16px; font-size:15px; letter-spacing:.06em; cursor:pointer; font-weight: 400; transition: background 0.2s; }
.sbtn:active { background-color:#3d5635; }
.sbtn.ghost { background: transparent; color: var(--primary); border: 1.5px solid var(--primary); margin-top: 10px; }
.sbtn.danger { background-color:var(--danger); margin-top:12px; }

/* â”€â”€ TOAST â”€â”€ */
#toast { position:fixed; left:50%; bottom:100px; transform:translateX(-50%) translateY(20px); background-color:#1a1a18; color:#fff; padding:12px 24px; border-radius:24px; font-size:14px; opacity:0; pointer-events:none; transition:all .3s ease; z-index:300; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
#toast.on { opacity:1; transform:translateX(-50%) translateY(0); }

/* â”€â”€ QUICK ACTIONS â”€â”€ */
#quick-assign { display: flex; gap: 8px; padding: 10px 18px; overflow-x: auto; background: var(--bg); border-bottom: 1px solid rgba(0,0,0,0.05); }
.qa-btn { white-space: nowrap; background: rgba(0,0,0,0.05); border: none; padding: 6px 12px; border-radius: 8px; font-size: 11px; color: var(--text-light); cursor: pointer; }
.qa-btn:active { background: rgba(0,0,0,0.1); }

/* Goals Enhanced */
.goal-card { margin:12px 18px; background:var(--card); border-radius:18px; padding:20px; border:1px solid rgba(0,0,0,0.08); position:relative; box-shadow: 0 4px 15px rgba(0,0,0,0.02); }
.goal-stripe { position:absolute; top:0; left:0; bottom:0; width:5px; border-radius:18px 0 0 18px; }
.goal-stripe.save { background: var(--primary); }
.goal-stripe.spend { background: var(--secondary); }
.goal-stripe.fund { background: var(--accent); }

::-webkit-scrollbar { width:0; height:0; }
</style>
</head>
<body>

<div id="app">
  <!-- Header con Pills -->
  <header id="header">
    <div id="top-bar">
      <div class="logo" onclick="location.reload()">é–“ Ma</div>
      <div class="month-nav">
        <button class="mnbtn" onclick="changeMonth(-1)">â€¹</button>
        <span id="month-lbl">Cargando...</span>
        <button class="mnbtn" onclick="changeMonth(1)">â€º</button>
      </div>
      <button class="hdr-btn" style="background:rgba(255,255,255,0.1); border:none; width:36px; height:36px; border-radius:50%; color:white; font-size:18px;" onclick="openSheet('cat')">ï¼‹</button>
    </div>
    <div id="pills">
      <div class="pill"><span class="pill-lbl">Ingresos</span><span class="pill-val g" id="p-income">â‚¬0</span></div>
      <div class="pill"><span class="pill-lbl">Asignado</span><span class="pill-val a" id="p-assigned">â‚¬0</span></div>
      <div class="pill"><span class="pill-lbl">Gastado</span><span class="pill-val r" id="p-spent">â‚¬0</span></div>
    </div>
  </header>

  <!-- Banner de Disponibilidad -->
  <div id="banner">
    <div onclick="openSheet('income_info')">
      <div class="banner-lbl">Listo para Asignar</div>
      <div id="to-assign">â‚¬0,00</div>
    </div>
    <div class="age-box" onclick="showPanel('rep')">
      <div id="age-num">0</div>
      <div class="age-lbl">dÃ­as dinero</div>
    </div>
  </div>

  <div id="scroll">
    <!-- PANEL: PRESUPUESTO -->
    <div class="panel on" id="panel-budget">
      <div id="quick-assign">
        <button class="qa-btn" onclick="quickAssign('reset')">Resetear todo</button>
        <button class="qa-btn" onclick="quickAssign('last')">Copiar mes anterior</button>
        <button class="qa-btn" onclick="quickAssign('underfunded')">Cubrir metas</button>
      </div>
      <div id="col-hdr">
        <span class="ch">CategorÃ­a</span>
        <span class="ch">Asignado</span>
        <span class="ch">Disponible</span>
      </div>
      <div id="budget-content"></div>
    </div>

    <!-- PANEL: MOVIMIENTOS -->
    <div class="panel" id="panel-tx">
      <div class="tx-sticky">
        <span id="tx-month-title">Movimientos</span>
        <span id="tx-count" style="font-size:10px">0 Ã­tems</span>
      </div>
      <div id="tx-content"></div>
    </div>

    <!-- PANEL: METAS -->
    <div class="panel" id="panel-goals">
      <div style="padding: 18px 18px 10px; display:flex; justify-content:space-between; align-items:center;">
        <h2 style="font-family:'Cormorant Garamond'; font-weight:300; font-size:24px;">Objetivos</h2>
        <button class="qa-btn" style="background:var(--primary); color:white" onclick="openSheet('goal')">+ Nueva Meta</button>
      </div>
      <div id="goals-content"></div>
    </div>

    <!-- PANEL: INFORMES -->
    <div class="panel" id="panel-rep">
      <div id="rep-content" style="padding: 18px;"></div>
    </div>

    <!-- PANEL: AJUSTES -->
    <div class="panel" id="panel-settings">
      <div style="padding: 24px 18px;">
        <h3 style="font-size:11px; text-transform:uppercase; letter-spacing:1px; color:var(--text-light); margin-bottom:15px;">Datos y Seguridad</h3>
        <button class="sbtn ghost" style="text-align:left; margin-bottom:10px;" onclick="exportData()">Exportar Copia de Seguridad (JSON)</button>
        <button class="sbtn ghost" style="text-align:left; margin-bottom:10px;" onclick="document.getElementById('import-file').click()">Importar Datos</button>
        <input type="file" id="import-file" style="display:none" onchange="importData(event)">
        <button class="sbtn danger" onclick="resetApp()">Borrar todo permanentemente</button>
      </div>
    </div>
  </div>

  <button id="fab" onclick="openSheet('tx')">ï¼‹</button>

  <nav id="nav">
    <button class="ntab on" id="tab-budget" onclick="showPanel('budget')">
      <span class="nicon">âŠž</span><span class="nlbl">Plan</span>
    </button>
    <button class="ntab" id="tab-tx" onclick="showPanel('tx')">
      <span class="nicon">â‰¡</span><span class="nlbl">Movs</span>
    </button>
    <button class="ntab" id="tab-goals" onclick="showPanel('goals')">
      <span class="nicon">â—Ž</span><span class="nlbl">Metas</span>
    </button>
    <button class="ntab" id="tab-rep" onclick="showPanel('rep')">
      <span class="nicon">â–¦</span><span class="nlbl">Stats</span>
    </button>
    <button class="ntab" id="tab-settings" onclick="showPanel('settings')">
      <span class="nicon">âš™</span><span class="nlbl">Ajustes</span>
    </button>
  </nav>
</div>

<!-- MODAL: TRANSACCIÃ“N -->
<div class="overlay" id="ov-tx">
  <div class="sheet">
    <div class="sh-handle"></div>
    <div class="sh-title" id="tx-title">TransacciÃ³n</div>
    
    <div style="display:flex; gap:10px; margin-bottom:20px;">
      <button id="type-exp" class="sbtn" style="flex:1" onclick="setTxType('expense')">Gasto</button>
      <button id="type-inc" class="sbtn ghost" style="flex:1" onclick="setTxType('income')">Ingreso</button>
    </div>

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px">
      <div class="fg"><label class="flbl">Importe â‚¬</label><input type="number" id="f-amt" class="finp" placeholder="0.00" inputmode="decimal"></div>
      <div class="fg"><label class="flbl">Fecha</label><input type="date" id="f-date" class="finp"></div>
    </div>
    
    <div class="fg"><label class="flbl">Concepto</label><input type="text" id="f-payee" class="finp" placeholder="Ej: Supermercado"></div>
    
    <div class="fg" id="cat-select-wrap">
      <label class="flbl">CategorÃ­a</label>
      <select id="f-cat" class="finp"></select>
    </div>

    <div style="display: flex; align-items:center; gap:10px; margin-bottom: 20px;">
      <input type="checkbox" id="f-rec" style="width:20px; height:20px;">
      <label for="f-rec" style="font-size:13px">Hacer transacciÃ³n recurrente</label>
    </div>

    <button class="sbtn" onclick="saveTx()">Guardar Movimiento</button>
    <button class="sbtn danger" id="del-tx-btn" style="display:none" onclick="deleteTx()">Eliminar</button>
  </div>
</div>

<!-- MODAL: CATEGORÃA -->
<div class="overlay" id="ov-cat">
  <div class="sheet">
    <div class="sh-handle"></div>
    <div class="sh-title">Nueva CategorÃ­a</div>
    <div class="fg"><label class="flbl">Grupo</label><select id="c-group" class="finp"></select></div>
    <div class="fg" id="new-group-wrap"><label class="flbl">Nombre del Grupo Nuevo</label><input type="text" id="c-new-group" class="finp" placeholder="Ej: Estilo de Vida"></div>
    <div style="display:grid; grid-template-columns: 60px 1fr; gap:12px">
      <div class="fg"><label class="flbl">Icono</label><input type="text" id="c-emoji" class="finp" placeholder="ðŸ±" maxlength="2"></div>
      <div class="fg"><label class="flbl">Nombre</label><input type="text" id="c-name" class="finp" placeholder="Ej: Restaurantes"></div>
    </div>
    <button class="sbtn" onclick="saveCategory()">Crear CategorÃ­a</button>
  </div>
</div>

<!-- MODAL: META -->
<div class="overlay" id="ov-goal">
  <div class="sheet">
    <div class="sh-handle"></div>
    <div class="sh-title">Establecer Objetivo</div>
    <div class="fg"><label class="flbl">Nombre</label><input type="text" id="g-name" class="finp" placeholder="Ej: Vacaciones"></div>
    <div class="fg"><label class="flbl">CategorÃ­a Vinculada</label><select id="g-cat" class="finp"></select></div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px">
      <div class="fg"><label class="flbl">Objetivo â‚¬</label><input type="number" id="g-target" class="finp" placeholder="1000"></div>
      <div class="fg"><label class="flbl">Fecha lÃ­mite</label><input type="month" id="g-date" class="finp"></div>
    </div>
    <div class="fg">
      <label class="flbl">Tipo de Meta</label>
      <select id="g-type" class="finp">
        <option value="save">Ahorro Acumulado (Para el futuro)</option>
        <option value="spend">Gasto Mensual (Presupuesto fijo)</option>
      </select>
    </div>
    <button class="sbtn" onclick="saveGoal()">Establecer Meta</button>
  </div>
</div>

<div id="toast"></div>

<script>
// --- MOTOR DE DATOS (Presupuesto Base Cero Real) ---
let DB = {
  groups: [],
  txs: [],
  assignments: {}, // Estructura: { "YYYY-MM": { catId: monto } }
  goals: [],
  settings: { currency: 'â‚¬' }
};

let currentMonth = new Date();
let activeTxId = null;
let currentTxType = 'expense';

// --- INICIALIZACIÃ“N ---
function init() {
  const saved = localStorage.getItem('ma_budget_pro_v1');
  if (saved) {
    DB = JSON.parse(saved);
  } else {
    // ConfiguraciÃ³n inicial de ejemplo
    DB.groups = [
      { id: 'g1', name: 'Obligatorios', cats: [
        { id: 'c1', name: 'Alquiler', emoji: 'ðŸ ' },
        { id: 'c2', name: 'Internet', emoji: 'ðŸŒ' }
      ]},
      { id: 'g2', name: 'Variable', cats: [
        { id: 'c3', name: 'Comida', emoji: 'ðŸ±' },
        { id: 'c4', name: 'Ocio', emoji: 'ðŸŽ¬' }
      ]}
    ];
  }
  updateUI();
}

function save() {
  localStorage.setItem('ma_budget_pro_v1', JSON.stringify(DB));
}

// --- LÃ“GICA DE PRESUPUESTO (CÃLCULOS CLAVE) ---
function getMonthKey(date) {
  return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
}

function getAvailable(catId, monthDate) {
  let totalAssigned = 0;
  let totalSpent = 0;
  
  const currentKey = getMonthKey(monthDate);

  // El disponible es ACUMULATIVO desde el inicio de los tiempos
  Object.keys(DB.assignments).forEach(mKey => {
    if (mKey <= currentKey) {
      totalAssigned += (DB.assignments[mKey][catId] || 0);
    }
  });

  DB.txs.forEach(t => {
    if (t.cat === catId && t.type === 'expense') {
      const tKey = t.date.substring(0, 7);
      if (tKey <= currentKey) {
        totalSpent += t.amt;
      }
    }
  });

  return totalAssigned - totalSpent;
}

function getToAssign(monthDate) {
  const currentKey = getMonthKey(monthDate);
  let totalIncome = 0;
  let totalAssigned = 0;

  DB.txs.forEach(t => {
    if (t.type === 'income') {
      const tKey = t.date.substring(0, 7);
      if (tKey <= currentKey) totalIncome += t.amt;
    }
  });

  Object.keys(DB.assignments).forEach(mKey => {
    if (mKey <= currentKey) {
      Object.values(DB.assignments[mKey]).forEach(val => totalAssigned += val);
    }
  });

  return totalIncome - totalAssigned;
}

// --- INTERFAZ ---
function updateUI() {
  const mKey = getMonthKey(currentMonth);
  document.getElementById('month-lbl').innerText = currentMonth.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' }).toUpperCase();
  
  const toAssignVal = getToAssign(currentMonth);
  const toAssignEl = document.getElementById('to-assign');
  toAssignEl.innerText = formatEuro(toAssignVal);
  toAssignEl.className = toAssignVal < 0 ? 'deficit' : '';

  renderBudget();
  renderTxs();
  renderGoals();
  renderReports();
  updatePills();
  save();
}

function renderBudget() {
  const mKey = getMonthKey(currentMonth);
  const container = document.getElementById('budget-content');
  container.innerHTML = '';

  if (!DB.assignments[mKey]) DB.assignments[mKey] = {};

  DB.groups.forEach(group => {
    let groupAssigned = 0;
    let groupAvail = 0;
    
    const groupDiv = document.createElement('div');
    const catsHtml = group.cats.map(cat => {
      const assigned = DB.assignments[mKey][cat.id] || 0;
      const avail = getAvailable(cat.id, currentMonth);
      groupAssigned += assigned;
      groupAvail += avail;

      const spentThisMonth = DB.txs
        .filter(t => t.cat === cat.id && t.type === 'expense' && t.date.startsWith(mKey))
        .reduce((sum, t) => sum + t.amt, 0);
      
      const progress = assigned > 0 ? Math.min((spentThisMonth / assigned) * 100, 100) : 0;

      return `
        <div class="c-row ${avail < 0 ? 'over' : ''}">
          <div class="c-info">
            <span class="c-emo">${cat.emoji}</span>
            <div class="c-txt">
              <div class="c-name">${cat.name}</div>
              <div class="c-prog"><div class="c-prog-fill ${avail < 0 ? 'ov' : ''}" style="width: ${progress}%"></div></div>
            </div>
          </div>
          <div class="c-assigned" onclick="editAssigned('${cat.id}', this)">
            <span class="val-txt">${formatEuro(assigned)}</span>
            <input type="number" class="c-inp" value="${assigned}" onblur="saveAssigned('${cat.id}', this)" inputmode="decimal">
          </div>
          <div class="c-avail ${avail > 0 ? 'pos' : (avail < 0 ? 'neg' : 'zer')}">${formatEuro(avail)}</div>
        </div>
      `;
    }).join('');

    groupDiv.innerHTML = `
      <div class="g-row" onclick="this.nextElementSibling.classList.toggle('hidden'); this.classList.toggle('closed')">
        <div class="g-title"><span class="chevron">â–¾</span>${group.name}</div>
        <div class="g-num">${formatEuro(groupAssigned)}</div>
        <div class="g-num">${formatEuro(groupAvail)}</div>
      </div>
      <div class="c-rows">${catsHtml}</div>
    `;
    container.appendChild(groupDiv);
  });
}

function renderTxs() {
  const mKey = getMonthKey(currentMonth);
  const container = document.getElementById('tx-content');
  const monthTxs = DB.txs.filter(t => t.date.startsWith(mKey)).sort((a,b) => new Date(b.date) - new Date(a.date));
  
  document.getElementById('tx-count').innerText = `${monthTxs.length} transacciones`;
  
  if (monthTxs.length === 0) {
    container.innerHTML = `<div style="text-align:center; padding:50px; color:#aaa;">No hay movimientos en este mes.</div>`;
    return;
  }

  container.innerHTML = monthTxs.map(t => {
    const cat = findCat(t.cat);
    return `
      <div class="tx-item" onclick="openEditTx('${t.id}')">
        <div class="tx-icon">${cat ? cat.emoji : (t.type === 'income' ? 'ðŸ’°' : 'ðŸ’¸')}</div>
        <div class="tx-mid">
          <div class="tx-payer">${t.payee}</div>
          <div class="tx-sub">${cat ? cat.name : 'Sin categorÃ­a'} Â· ${t.date.split('-')[2]} ${getMonthName(t.date)}</div>
        </div>
        <div class="tx-amt ${t.type === 'income' ? 'inc' : ''}">${t.type === 'income' ? '+' : '-'}${formatEuro(t.amt)}</div>
      </div>
    `;
  }).join('');
}

function renderGoals() {
  const container = document.getElementById('goals-content');
  if (DB.goals.length === 0) {
    container.innerHTML = `<div style="text-align:center; padding:50px; color:#aaa;">Define metas para ahorrar o controlar gastos.</div>`;
    return;
  }

  container.innerHTML = DB.goals.map(g => {
    const cat = findCat(g.cat);
    const current = g.type === 'save' ? getAvailable(g.cat, new Date()) : 
                    DB.txs.filter(t => t.cat === g.cat && t.type === 'expense' && t.date.startsWith(getMonthKey(currentMonth))).reduce((s,t)=>s+t.amt,0);
    
    const pct = Math.min((current / g.target) * 100, 100);

    return `
      <div class="goal-card">
        <div class="goal-stripe ${g.type}"></div>
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
          <div style="font-weight:500">${g.name}</div>
          <div style="font-size:11px; color:var(--text-light)">${cat ? cat.emoji + ' ' + cat.name : ''}</div>
        </div>
        <div class="c-prog" style="height:6px; margin-bottom:10px;"><div class="c-prog-fill" style="width:${pct}%"></div></div>
        <div style="display:flex; justify-content:space-between; align-items:baseline">
          <div style="font-family:'Cormorant Garamond'; font-size:20px">${formatEuro(current)} <span style="font-size:12px; color:#aaa">de ${formatEuro(g.target)}</span></div>
          <div style="font-size:12px; font-weight:500">${pct.toFixed(0)}%</div>
        </div>
      </div>
    `;
  }).join('');
}

function updatePills() {
  const mKey = getMonthKey(currentMonth);
  const inc = DB.txs.filter(t => t.type === 'income' && t.date.startsWith(mKey)).reduce((s,t)=>s+t.amt, 0);
  const spent = DB.txs.filter(t => t.type === 'expense' && t.date.startsWith(mKey)).reduce((s,t)=>s+t.amt, 0);
  const assigned = Object.values(DB.assignments[mKey] || {}).reduce((s,v)=>s+v, 0);

  document.getElementById('p-income').innerText = formatEuro(inc);
  document.getElementById('p-spent').innerText = formatEuro(spent);
  document.getElementById('p-assigned').innerText = formatEuro(assigned);
  
  // Edad del dinero (Simplificado: DÃ­as de gastos cubiertos por ingresos histÃ³ricos)
  const totalInc = DB.txs.filter(t => t.type === 'income').reduce((s,t)=>s+t.amt,0);
  const avgSpent = spent || 1;
  document.getElementById('age-num').innerText = Math.floor(Math.min(totalInc / (avgSpent / 30), 99));
}

// --- ACCIONES ---
function changeMonth(dir) {
  currentMonth.setMonth(currentMonth.getMonth() + dir);
  updateUI();
}

function editAssigned(catId, el) {
  const txt = el.querySelector('.val-txt');
  const inp = el.querySelector('.c-inp');
  el.classList.add('editing');
  txt.style.display = 'none';
  inp.style.display = 'block';
  inp.focus();
  inp.select();
}

function saveAssigned(catId, inp) {
  const val = parseFloat(inp.value) || 0;
  const mKey = getMonthKey(currentMonth);
  
  if (!DB.assignments[mKey]) DB.assignments[mKey] = {};
  DB.assignments[mKey][catId] = val;
  
  inp.parentElement.classList.remove('editing');
  updateUI();
}

function quickAssign(type) {
  const mKey = getMonthKey(currentMonth);
  if (type === 'reset') {
    DB.assignments[mKey] = {};
  } else if (type === 'last') {
    const lastMonth = new Date(currentMonth);
    lastMonth.setMonth(lastMonth.getMonth() - 1);
    const lastKey = getMonthKey(lastMonth);
    DB.assignments[mKey] = JSON.parse(JSON.stringify(DB.assignments[lastKey] || {}));
  }
  updateUI();
  showToast("Presupuesto actualizado");
}

function saveTx() {
  const amt = parseFloat(document.getElementById('f-amt').value);
  const payee = document.getElementById('f-payee').value;
  const date = document.getElementById('f-date').value;
  const cat = document.getElementById('f-cat').value;

  if (!amt || !payee || !date) return showToast("Faltan datos");

  const tx = {
    id: activeTxId || Date.now().toString(),
    amt, payee, date, cat,
    type: currentTxType
  };

  if (activeTxId) {
    const idx = DB.txs.findIndex(t => t.id === activeTxId);
    DB.txs[idx] = tx;
  } else {
    DB.txs.push(tx);
  }

  closeSheet('tx');
  updateUI();
  showToast("TransacciÃ³n guardada");
}

function openEditTx(id) {
  const tx = DB.txs.find(t => t.id === id);
  activeTxId = id;
  setTxType(tx.type);
  document.getElementById('f-amt').value = tx.amt;
  document.getElementById('f-payee').value = tx.payee;
  document.getElementById('f-date').value = tx.date;
  document.getElementById('f-cat').value = tx.cat;
  document.getElementById('del-tx-btn').style.display = 'block';
  openSheet('tx');
}

function deleteTx() {
  DB.txs = DB.txs.filter(t => t.id !== activeTxId);
  closeSheet('tx');
  updateUI();
  showToast("Eliminado");
}

function saveCategory() {
  const name = document.getElementById('c-name').value;
  const emoji = document.getElementById('c-emoji').value || 'ðŸ“';
  const groupId = document.getElementById('c-group').value;
  const newGroupName = document.getElementById('c-new-group').value;

  const newCat = { id: 'c' + Date.now(), name, emoji };

  if (groupId === 'new') {
    DB.groups.push({ id: 'g' + Date.now(), name: newGroupName, cats: [newCat] });
  } else {
    const g = DB.groups.find(g => g.id === groupId);
    g.cats.push(newCat);
  }

  closeSheet('cat');
  updateUI();
}

function saveGoal() {
  const goal = {
    id: Date.now().toString(),
    name: document.getElementById('g-name').value,
    cat: document.getElementById('g-cat').value,
    target: parseFloat(document.getElementById('g-target').value),
    date: document.getElementById('g-date').value,
    type: document.getElementById('g-type').value
  };
  DB.goals.push(goal);
  closeSheet('goal');
  updateUI();
}

// --- UTILIDADES ---
function formatEuro(num) {
  return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(num);
}

function getMonthName(dateStr) {
  const d = new Date(dateStr);
  return d.toLocaleDateString('es-ES', { month: 'short' });
}

function findCat(id) {
  for (let g of DB.groups) {
    let c = g.cats.find(c => c.id === id);
    if (c) return c;
  }
  return null;
}

function showPanel(id) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('on'));
  document.querySelectorAll('.ntab').forEach(t => t.classList.remove('on'));
  document.getElementById('panel-' + id).classList.add('on');
  document.getElementById('tab-' + id).classList.add('on');
  if (id === 'rep' || id === 'settings') document.getElementById('fab').style.display = 'none';
  else document.getElementById('fab').style.display = 'flex';
}

function openSheet(id) {
  if (id === 'tx' && !activeTxId) {
    document.getElementById('f-date').valueAsDate = new Date();
    document.getElementById('f-amt').value = '';
    document.getElementById('f-payee').value = '';
    document.getElementById('del-tx-btn').style.display = 'none';
    setTxType('expense');
  }
  
  // Poblar selects
  if (id === 'tx' || id === 'goal') {
    const sel = document.getElementById(id === 'tx' ? 'f-cat' : 'g-cat');
    sel.innerHTML = '<option value="">Sin categorÃ­a</option>' + DB.groups.map(g => 
      `<optgroup label="${g.name}">${g.cats.map(c => `<option value="${c.id}">${c.emoji} ${c.name}</option>`).join('')}</optgroup>`
    ).join('');
  }

  if (id === 'cat') {
    const sel = document.getElementById('c-group');
    sel.innerHTML = DB.groups.map(g => `<option value="${g.id}">${g.name}</option>`).join('') + '<option value="new">+ Crear nuevo grupo</option>';
    document.getElementById('new-group-wrap').style.display = 'none';
    sel.onchange = (e) => document.getElementById('new-group-wrap').style.display = e.target.value === 'new' ? 'block' : 'none';
  }

  document.getElementById('ov-' + id).classList.add('open');
}

function closeSheet(id) {
  document.getElementById('ov-' + id).classList.remove('open');
  activeTxId = null;
}

function setTxType(type) {
  currentTxType = type;
  document.getElementById('type-exp').className = type === 'expense' ? 'sbtn' : 'sbtn ghost';
  document.getElementById('type-inc').className = type === 'income' ? 'sbtn' : 'sbtn ghost';
  document.getElementById('cat-select-wrap').style.display = type === 'income' ? 'none' : 'block';
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.innerText = msg;
  t.classList.add('on');
  setTimeout(() => t.classList.remove('on'), 2500);
}

function exportData() {
  const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(DB));
  const downloadAnchorNode = document.createElement('a');
  downloadAnchorNode.setAttribute("href", dataStr);
  downloadAnchorNode.setAttribute("download", "ma_budget_backup.json");
  document.body.appendChild(downloadAnchorNode);
  downloadAnchorNode.click();
  downloadAnchorNode.remove();
}

function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    DB = JSON.parse(e.target.result);
    updateUI();
    showToast("Datos importados");
  };
  reader.readAsText(file);
}

function resetApp() {
  if (confirm("Â¿EstÃ¡s seguro? Se borrarÃ¡n todos los datos.")) {
    localStorage.clear();
    location.reload();
  }
}

// Cerrar modales al tocar fuera
document.querySelectorAll('.overlay').forEach(ov => {
  ov.onclick = (e) => { if (e.target === ov) ov.classList.remove('open'); };
});

window.onload = init;
</script>
</body>
</html>


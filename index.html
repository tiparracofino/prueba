<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Èñì Ma Budget</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500&family=Noto+Sans+JP:wght@300;400&display=swap" rel="stylesheet">
<style>
/* SISTEMA DE DISE√ëO: MA (ESPACIO NEGATIVO) */
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
html { height:100%; }
body { height:100%; font-family:'Noto Sans JP',sans-serif; font-size:14px; font-weight:300; color:#1a1a18; background:#f0ece3; overflow:hidden; -webkit-font-smoothing:antialiased; }
#app { display:flex; flex-direction:column; height:100%; }

/* CABECERA */
#header { background-color:#1a1a18; flex-shrink:0; padding-top:max(env(safe-area-inset-top), 20px); }
#top-bar { display:flex; align-items:center; justify-content:space-between; padding:10px 18px 16px; gap:8px; }
.logo { font-family:'Cormorant Garamond',serif; font-size:22px; font-weight:300; color:#c4a46a; letter-spacing:.1em; cursor:pointer; }
.month-nav { display:flex; align-items:center; background-color:rgba(255,255,255,.12); border-radius:99px; overflow:hidden; }
.mnbtn { width:44px; height:34px; background:none; border:none; color:rgba(255,255,255,.8); font-size:18px; cursor:pointer; display:flex; align-items:center; justify-content:center; }
#month-lbl { color:#fff; font-family:'Cormorant Garamond',serif; font-size:16px; letter-spacing:.05em; min-width:110px; text-align:center; }
.hdr-btn { width:36px; height:36px; background-color:rgba(255,255,255,.12); border:none; border-radius:50%; color:rgba(255,255,255,.85); font-size:20px; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0; }

#pills { display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; padding:0 18px 18px; }
.pill { background-color:rgba(255,255,255,.10); border-radius:10px; padding:10px 8px; text-align:center; }
.pill-lbl { display:block; font-size:9px; letter-spacing:.13em; text-transform:uppercase; color:rgba(255,255,255,.45); margin-bottom:4px; }
.pill-val { font-family:'Cormorant Garamond',serif; font-size:18px; color:#fff; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.pill-val.g { color:#8fcc7a; } .pill-val.a { color:#ddb96a; } .pill-val.r { color:#d47a7a; }

/* BANNER */
#banner { background-color:#4a6741; display:flex; align-items:center; justify-content:space-between; padding:16px 18px; flex-shrink:0; box-shadow:0 2px 10px rgba(0,0,0,0.1); z-index: 10; }
.banner-lbl { font-size:9px; letter-spacing:.14em; text-transform:uppercase; color:rgba(255,255,255,.7); margin-bottom:2px; }
#to-assign { font-family:'Cormorant Garamond',serif; font-size:28px; font-weight:300; color:#c8e8b0; cursor:pointer; border-bottom:1px dashed rgba(255,255,255,.3); line-height: 1.1; }
#to-assign.deficit { color:#f0b0b0; }
.age-box { background-color:rgba(0,0,0,.20); border-radius:20px; padding:6px 16px; text-align:center; cursor:pointer; }
#age-num { font-family:'Cormorant Garamond',serif; font-size:24px; line-height:1; color:#fff; }
.age-lbl { font-size:8px; letter-spacing:.1em; text-transform:uppercase; color:rgba(255,255,255,.6); }

/* √ÅREA DE SCROLL */
#scroll { flex:1; overflow-y:auto; overflow-x:hidden; -webkit-overflow-scrolling:touch; padding-bottom:100px; position: relative; }
.panel { display:none; animation: fadeIn 0.15s ease-out; } .panel.on { display:block; }
@keyframes fadeIn { from { opacity:0; transform:translateY(5px); } to { opacity:1; transform:translateY(0); } }

/* TABLA PRESUPUESTO */
#col-hdr { display:grid; grid-template-columns:1fr 85px 85px; padding:10px 18px 8px; position:sticky; top:0; z-index:9; background-color:#f0ece3; border-bottom:1px solid rgba(0,0,0,.08); font-weight: 500; }
.ch { font-size:9px; letter-spacing:.13em; text-transform:uppercase; color:#888884; } .ch:not(:first-child) { text-align:right; }

/* GRUPOS Y CATEGOR√çAS */
.g-row { display:grid; grid-template-columns:1fr 85px 85px; padding:12px 18px; background-color:#e6e2d8; border-top:1px solid rgba(0,0,0,.07); cursor:pointer; user-select:none; align-items:center; }
.g-title { display:flex; align-items:center; gap:6px; font-size:11px; letter-spacing:.12em; text-transform:uppercase; color:#3a3a36; font-weight:500; }
.chevron { font-size:9px; color:#888884; transition:transform .2s; } .g-row.closed .chevron { transform:rotate(-90deg); }
.g-num { font-family:'Cormorant Garamond',serif; font-size:15px; color:#3a3a36; text-align:right; font-weight: 500; }
.c-rows.hidden { display:none; }
.c-row { display:grid; grid-template-columns:1fr 85px 85px; padding:12px 18px 12px 24px; background-color:#fdfbf7; border-top:1px solid rgba(0,0,0,.04); align-items:center; position: relative; }
.c-row.over { border-left:3px solid #b04a4a; padding-left:21px; }
.c-info { display:flex; align-items:center; gap:10px; min-width:0; cursor: pointer; }
.c-emo { font-size:16px; flex-shrink:0; width: 24px; text-align: center; }
.c-txt { min-width:0; flex:1; }
.c-name { font-size:14px; color:#1a1a18; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.c-prog { height:3px; background:rgba(0,0,0,.06); border-radius:2px; margin-top:5px; overflow:hidden; width: 90%; }
.c-prog-fill { height:100%; background-color:#6a9a5c; border-radius:2px; }
.c-prog-fill.ov { background-color:#b04a4a; }
.c-assigned { font-family:'Cormorant Garamond',serif; font-size:17px; color:#3a3a36; text-align:right; cursor:pointer; padding:4px 6px; border-radius:6px; position:relative; transition: background .1s; }
.c-assigned.editing { background-color:#fff; outline:2px solid #4a6741; box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 5; }
.c-inp { position:absolute; inset:0; background:transparent; border:none; outline:none; font-family:'Cormorant Garamond',serif; font-size:17px; text-align:right; color:#1a1a18; padding:0 6px; display:none; width:100%; border-radius: 6px; }
.c-avail { font-family:'Cormorant Garamond',serif; font-size:17px; text-align:right; padding-right:2px; font-weight: 500; }
.c-avail.pos { color:#4a6741; } .c-avail.neg { color:#b04a4a; } .c-avail.zer { color:#ccc; }
.add-cat { padding:14px 18px 14px 30px; background-color:#fdfbf7; border-top:1px solid rgba(0,0,0,.04); color:#4a6741; font-size:12px; letter-spacing:.04em; cursor:pointer; font-weight: 500; }

/* TRANSACCIONES */
.tx-sticky { padding:12px 18px 8px; font-size:9px; letter-spacing:.13em; text-transform:uppercase; color:#888884; background-color:#f0ece3; position:sticky; top:0; z-index:8; border-bottom:1px solid rgba(0,0,0,.07); display:flex; justify-content:space-between; align-items:center; }
.tx-swipe-wrap { position:relative; overflow:hidden; background-color:#b04a4a; }
.tx-swipe-wrap .tx-del-bg { position:absolute; right:0; top:0; bottom:0; width:80px; display:flex; align-items:center; justify-content:center; background-color:#b04a4a; color:#fff; font-size:13px; letter-spacing:.05em; flex-direction:column; gap:2px; pointer-events:none; }
.tx-item { display:flex; align-items:center; padding:14px 18px; background-color:#fdfbf7; border-top:1px solid rgba(0,0,0,.04); gap:14px; cursor:pointer; transition:background .12s; position:relative; transform:translateX(0); will-change:transform; touch-action:pan-y; }
.tx-item:active { background-color:#e6e2d8; }
.tx-icon { width:42px; height:42px; border-radius:50%; background-color:#e6e2d8; display:flex; align-items:center; justify-content:center; font-size:18px; flex-shrink:0; position:relative; color: #555; }
.tx-recurring-dot { position:absolute; bottom:-2px; right:-2px; width:14px; height:14px; background-color:#3a6878; border-radius:50%; border:2px solid #fdfbf7; font-size:8px; display:flex; align-items:center; justify-content:center; color:#fff; font-weight: bold; }
.tx-payer { font-size:15px; color:#1a1a18; font-weight: 400; }
.tx-amt { font-family:'Cormorant Garamond',serif; font-size:19px; font-weight: 500; }
.tx-amt.income { color:#4a6741; }

/* INFORMES (SVG CHART) */
.rep-wrap { padding:18px; }
.rep-card { background-color:#fdfbf7; border-radius:18px; border:1px solid rgba(0,0,0,.06); padding:20px; margin-bottom:16px; }
.rep-ttl { font-family:'Cormorant Garamond',serif; font-size:20px; margin-bottom:18px; color:#1a1a18; }
.chart-container { display: flex; align-items: center; gap: 20px; margin-top: 10px; }
.chart-svg { width: 120px; height: 120px; transform: rotate(-90deg); flex-shrink: 0; }
.chart-legend { flex: 1; display: flex; flex-direction: column; gap: 8px; }
.legend-item { display: flex; align-items: center; gap: 8px; font-size: 11px; color: #555; }
.legend-dot { width: 8px; height: 8px; border-radius: 2px; }

/* METAS */
.goal-card { margin:14px 18px 0; background-color:#fdfbf7; border-radius:18px; padding:20px; border:1px solid rgba(0,0,0,.06); position:relative; overflow:hidden; }
.goal-stripe { position:absolute; top:0; left:0; right:0; height:4px; }
.goal-stripe.save { background-color:#4a6741; } .goal-stripe.debt { background-color:#b04a4a; } .goal-stripe.spend { background-color:#3a6878; }
.gbadge { font-size:9px; letter-spacing:.09em; padding:4px 10px; border-radius:8px; font-weight: 600; }
.gbadge.save { background-color:#c8d8bf; color:#4a6741; }
.goal-sv { font-family:'Cormorant Garamond',serif; font-size:24px; }

/* BARRA NAVEGACI√ìN */
#nav { position:fixed; bottom:0; left:0; right:0; background-color:#1a1a18; display:flex; z-index:99; padding-bottom:env(safe-area-inset-bottom,0); border-top:1px solid rgba(255,255,255,.07); height: calc(60px + env(safe-area-inset-bottom,0)); }
.ntab { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; background:none; border:none; color:rgba(255,255,255,.35); cursor:pointer; }
.ntab.on { color:#c4a46a; }

/* BOT√ìN FLOTANTE */
#fab { position:fixed; right:20px; bottom:calc(75px + env(safe-area-inset-bottom,0px)); width:56px; height:56px; background-color:#4a6741; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:28px; color:#fff; border:none; z-index:50; box-shadow:0 4px 18px rgba(74,103,65,.4); }

/* OVERLAYS / SHEETS */
.overlay { position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:200; display:flex; align-items:flex-end; opacity:0; pointer-events:none; transition:opacity .2s; backdrop-filter: blur(2px); }
.overlay.open { opacity:1; pointer-events:all; }
.sheet { background-color:#fdfbf7; border-radius:24px 24px 0 0; width:100%; padding:20px 24px calc(24px + env(safe-area-inset-bottom,0)); transform:translateY(100%); transition:transform .3s cubic-bezier(0.16, 1, 0.3, 1); max-height:90vh; overflow-y:auto; }
.overlay.open .sheet { transform:translateY(0); }
.sh-handle { width:40px; height:4px; background-color:#d0ccc4; border-radius:2px; margin:0 auto 20px; }
.sh-title { font-family:'Cormorant Garamond',serif; font-size:24px; margin-bottom:20px; }
.fg { margin-bottom:16px; }
.flbl { font-size:10px; letter-spacing:.1em; text-transform:uppercase; color:#888; display:block; margin-bottom:6px; font-weight: 600; }
.finp { width:100%; background-color:#e6e2d8; border:1.5px solid transparent; border-radius:12px; padding:12px; font-size:16px; outline:none; transition: .2s; }
.finp:focus { border-color:#4a6741; background-color:#fff; }
.sbtn { width:100%; background-color:#4a6741; color:#fff; border:none; border-radius:14px; padding:16px; font-size:15px; cursor:pointer; font-weight: 500; }
.sbtn.danger { background-color:#b04a4a; margin-top:10px; }

/* UTIL */
#toast { position:fixed; left:50%; bottom:90px; transform:translateX(-50%) translateY(20px); background:#1a1a18; color:#fff; padding:10px 20px; border-radius:20px; font-size:13px; opacity:0; transition:.3s; z-index:300; pointer-events:none; }
#toast.on { opacity:1; transform:translateX(-50%) translateY(0); }
</style>
</head>
<body>

<div id="app">
  <div id="header">
    <div id="top-bar">
      <div class="logo" onclick="showPanel('settings')">Èñì Ma</div>
      <div class="month-nav">
        <button class="mnbtn" onclick="chMonth(-1)">‚Äπ</button>
        <span id="month-lbl"></span>
        <button class="mnbtn" onclick="chMonth(1)">‚Ä∫</button>
      </div>
      <button class="hdr-btn" onclick="openSh('cat')">Ôºã</button>
    </div>
    <div id="pills">
      <div class="pill"><span class="pill-lbl">Ingresos</span><span class="pill-val g" id="p-income">‚Ç¨0</span></div>
      <div class="pill"><span class="pill-lbl">Saldo Real</span><span class="pill-val a" id="p-assigned">‚Ç¨0</span></div>
      <div class="pill"><span class="pill-lbl">Gastado</span><span class="pill-val r" id="p-spent">‚Ç¨0</span></div>
    </div>
  </div>

  <div id="banner">
    <div>
      <div class="banner-lbl">Libre para asignar</div>
      <div id="to-assign" onclick="openSh('income')">‚Ç¨0,00</div>
    </div>
    <div class="age-box">
      <div id="age-num">0</div>
      <div class="age-lbl">d√≠as dinero</div>
    </div>
  </div>

  <div id="scroll">
    <div class="panel on" id="panel-budget">
      <div id="col-hdr"><span class="ch">Categor√≠a</span><span class="ch">Asignado</span><span class="ch">Disponible</span></div>
      <div id="b-body"></div>
    </div>

    <div class="panel" id="panel-tx">
      <div class="tx-sticky"><span>Movimientos</span><span id="tx-rec-count" onclick="openSh('recurring')"></span></div>
      <div id="tx-body"></div>
    </div>

    <div class="panel" id="panel-goals">
      <div style="display:flex; justify-content:space-between; padding:18px; align-items:center;">
        <span style="font-family:'Cormorant Garamond',serif; font-size:22px;">Metas</span>
        <button class="sbtn" style="width:auto; padding:8px 16px;" onclick="openSh('goal')">+ Nueva</button>
      </div>
      <div id="g-body"></div>
    </div>

    <div class="panel" id="panel-rep">
      <div class="rep-wrap" id="rep-body"></div>
    </div>

    <div class="panel" id="panel-settings">
      <div style="padding:20px;">
        <div class="fg"><button class="sbtn" onclick="exportJSON()">Exportar JSON</button></div>
        <div class="fg"><button class="sbtn" style="background:#888" onclick="document.getElementById('import-input').click()">Importar JSON</button></div>
        <input type="file" id="import-input" style="display:none" onchange="importJSON(event)">
        <button class="sbtn danger" onclick="confirmReset()">Borrar todo</button>
      </div>
    </div>
  </div>

  <button id="fab" onclick="openSh('tx')">Ôºã</button>

  <nav id="nav">
    <button class="ntab on" id="tab-budget" onclick="showPanel('budget')">Plan</button>
    <button class="ntab" id="tab-tx" onclick="showPanel('tx')">Movs</button>
    <button class="ntab" id="tab-goals" onclick="showPanel('goals')">Metas</button>
    <button class="ntab" id="tab-rep" onclick="showPanel('rep')">Info</button>
    <button class="ntab" id="tab-settings" onclick="showPanel('settings')">‚öô</button>
  </nav>
</div>

<div class="overlay" id="ov-tx">
  <div class="sheet">
    <div class="sh-handle"></div>
    <div class="sh-title" id="tx-sh-title">Nueva transacci√≥n</div>
    <div style="display:flex; gap:8px; margin-bottom:16px">
      <button class="sbtn" id="btn-t-exp" onclick="setType('expense')" style="background:#e6e2d8; color:#3a3a36">Gasto</button>
      <button class="sbtn" id="btn-t-inc" onclick="setType('income')" style="background:#e6e2d8; color:#3a3a36">Ingreso</button>
    </div>
    <div class="fg"><label class="flbl">Importe ‚Ç¨</label><input type="number" class="finp" id="f-amt" step="0.01"></div>
    <div class="fg"><label class="flbl">Descripci√≥n</label><input type="text" class="finp" id="f-pay"></div>
    <div class="fg" id="f-cat-fg"><label class="flbl">Categor√≠a</label><select class="finp" id="f-cat"></select></div>
    <div class="fg"><label class="flbl">Fecha</label><input type="date" class="finp" id="f-date"></div>
    <button class="sbtn" onclick="saveTx()">Guardar</button>
    <button class="sbtn danger" id="tx-del-btn" onclick="deleteTx()" style="display:none">Eliminar</button>
  </div>
</div>

<div class="overlay" id="ov-cat">
  <div class="sheet">
    <div class="sh-handle"></div>
    <div class="sh-title">Nueva Categor√≠a</div>
    <div class="fg"><label class="flbl">Grupo</label><select class="finp" id="c-grp"></select></div>
    <div class="fg" id="c-newg-wrap"><label class="flbl">Nombre Grupo Nuevo</label><input type="text" class="finp" id="c-newg"></div>
    <div class="fg"><label class="flbl">Emoji</label><input type="text" class="finp" id="c-emo" placeholder="üìå"></div>
    <div class="fg"><label class="flbl">Nombre Categor√≠a</label><input type="text" class="finp" id="c-nm"></div>
    <button class="sbtn" onclick="saveCat()">Crear</button>
  </div>
</div>

<div class="overlay" id="ov-goal">
  <div class="sheet">
    <div class="sh-handle"></div>
    <div class="sh-title" id="goal-sh-title">Nueva Meta</div>
    <div class="fg"><label class="flbl">Nombre</label><input type="text" class="finp" id="g-nm"></div>
    <div class="fg"><label class="flbl">Categor√≠a Vinculada</label><select class="finp" id="g-cat-link"></select></div>
    <div class="fg"><label class="flbl">Objetivo ‚Ç¨</label><input type="number" class="finp" id="g-tgt"></div>
    <div class="fg"><label class="flbl">Fecha L√≠mite</label><input type="month" class="finp" id="g-dt"></div>
    <button class="sbtn" id="goal-save-btn" onclick="saveGoal()">Crear Meta</button>
    <button class="sbtn danger" id="goal-del-btn" style="display:none" onclick="deleteGoal()">Eliminar Meta</button>
  </div>
</div>

<div id="toast"></div>

<script>
// ESTADO
let S = JSON.parse(localStorage.getItem('ma-v7')) || { groups: [], monthData: {}, txs: [], goals: [] };
let currentMonth = new Date();
let txType = 'expense';
let editingTxId = null;
let editingGoalId = null;

const MESES = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
const ef = n => '‚Ç¨' + Math.abs(n).toFixed(2).replace('.',',');
const uid = () => '_' + Math.random().toString(36).slice(2,9);

// LOGICA PRESUPUESTO
function monthKey(d) { return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }
function getMonthData(mk) { if(!S.monthData[mk]) S.monthData[mk] = { assignments: {} }; return S.monthData[mk]; }

function calcCatAvailable(catId, currentMk) {
  let assigned = 0;
  Object.keys(S.monthData).forEach(mk => { if(mk <= currentMk) assigned += (S.monthData[mk].assignments[catId] || 0); });
  let spent = S.txs.filter(t => t.cat === catId && t.type === 'expense' && t.month <= currentMk).reduce((s,t) => s + t.amt, 0);
  return assigned - spent;
}

function save() { localStorage.setItem('ma-v7', JSON.stringify(S)); }

// RENDERS
function fullRender() { renderBudget(); renderTx(); updateHeader(); if(document.getElementById('panel-rep').classList.contains('on')) renderRep(); }

function updateHeader() {
  const mk = monthKey(currentMonth);
  const inc = S.txs.filter(t => t.month === mk && t.type === 'income').reduce((s,t) => s + t.amt, 0);
  const spent = S.txs.filter(t => t.month === mk && t.type === 'expense').reduce((s,t) => s + t.amt, 0);
  
  // Libre para asignar = Total Ingresos Hist√≥ricos - Total Asignado Hist√≥rico
  let totalInc = S.txs.filter(t => t.type === 'income' && t.month <= mk).reduce((s,t) => s + t.amt, 0);
  let totalAssigned = 0;
  Object.keys(S.monthData).forEach(m => { if(m <= mk) Object.values(S.monthData[m].assignments).forEach(v => totalAssigned += v); });
  
  document.getElementById('p-income').textContent = ef(inc);
  document.getElementById('p-spent').textContent = ef(spent);
  document.getElementById('to-assign').textContent = ef(totalInc - totalAssigned);
  document.getElementById('month-lbl').textContent = MESES[currentMonth.getMonth()] + ' ' + currentMonth.getFullYear();
}

function renderBudget() {
  const mk = monthKey(currentMonth);
  const body = document.getElementById('b-body');
  body.innerHTML = '';
  
  S.groups.forEach(g => {
    const div = document.createElement('div');
    let gAssigned = 0, gAvail = 0;
    g.cats.forEach(c => { gAssigned += (getMonthData(mk).assignments[c.id] || 0); gAvail += calcCatAvailable(c.id, mk); });
    
    div.innerHTML = `<div class="g-row"><div class="g-title">‚ñæ ${g.name}</div><div class="g-num">${ef(gAssigned)}</div><div class="g-num">${ef(gAvail)}</div></div>`;
    const cbox = document.createElement('div');
    cbox.className = 'c-rows';
    g.cats.forEach(c => {
      const ass = getMonthData(mk).assignments[c.id] || 0;
      const av = calcCatAvailable(c.id, mk);
      const row = document.createElement('div');
      row.className = 'c-row' + (av < 0 ? ' over' : '');
      row.innerHTML = `
        <div class="c-info"><span class="c-emo">${c.emoji}</span><div class="c-name">${c.name}</div></div>
        <div class="c-assigned" onclick="editAssigned('${c.id}', this)">${ef(ass)}</div>
        <div class="c-avail ${av<0?'neg':'pos'}">${ef(av)}</div>`;
      cbox.appendChild(row);
    });
    div.appendChild(cbox);
    body.appendChild(div);
  });
}

function editAssigned(id, el) {
  const val = getMonthData(monthKey(currentMonth)).assignments[id] || 0;
  const inp = document.createElement('input');
  inp.type = 'number'; inp.className = 'finp'; inp.style.width = '70px'; inp.value = val;
  el.innerHTML = ''; el.appendChild(inp); inp.focus();
  inp.onblur = () => {
    getMonthData(monthKey(currentMonth)).assignments[id] = parseFloat(inp.value) || 0;
    save(); fullRender();
  };
}

function renderTx() {
  const mk = monthKey(currentMonth);
  const body = document.getElementById('tx-body');
  const txs = S.txs.filter(t => t.month === mk).sort((a,b) => b.date.localeCompare(a.date));
  body.innerHTML = txs.map(t => `
    <div class="tx-item" onclick="openEditTx('${t.id}')">
      <div class="tx-icon">${t.type==='income'?'üí∞':'üí∏'}</div>
      <div style="flex:1">
        <div class="tx-payer">${t.pay}</div>
        <div style="font-size:11px; color:#888">${t.date}</div>
      </div>
      <div class="tx-amt ${t.type}">${t.type==='income'?'+':'-'}${ef(t.amt)}</div>
    </div>`).join('');
}

// NUEVO: GR√ÅFICO SVG EN INFORMES
function renderRep() {
  const mk = monthKey(currentMonth);
  const body = document.getElementById('rep-body');
  
  // Datos por grupo
  const totals = {};
  let totalSpent = 0;
  S.txs.filter(t => t.month === mk && t.type === 'expense').forEach(t => {
    const cat = findCat(t.cat);
    const groupName = cat ? cat.groupName : 'Sin Grupo';
    totals[groupName] = (totals[groupName] || 0) + t.amt;
    totalSpent += t.amt;
  });

  const colors = ['#4a6741', '#c4a46a', '#3a6878', '#b04a4a', '#888'];
  let currentPos = 0;
  let chartHtml = '';
  let legendHtml = '';

  Object.keys(totals).forEach((grp, i) => {
    const percent = (totals[grp] / totalSpent) * 100;
    const color = colors[i % colors.length];
    const strokeDash = `${percent} 100`;
    chartHtml += `<circle cx="16" cy="16" r="15.9" fill="transparent" stroke="${color}" stroke-width="3" stroke-dasharray="${strokeDash}" stroke-dashoffset="-${currentPos}"></circle>`;
    currentPos += percent;
    legendHtml += `<div class="legend-item"><div class="legend-dot" style="background:${color}"></div>${grp}: ${ef(totals[grp])}</div>`;
  });

  body.innerHTML = `
    <div class="rep-card">
      <div class="rep-ttl">Distribuci√≥n de Gastos</div>
      <div class="chart-container">
        <svg class="chart-svg" viewBox="0 0 32 32">${chartHtml || '<circle cx="16" cy="16" r="15.9" fill="transparent" stroke="#eee" stroke-width="3"></circle>'}</svg>
        <div class="chart-legend">${legendHtml || 'Sin gastos este mes'}</div>
      </div>
    </div>`;
}

// METAS
function renderGoals() {
  const body = document.getElementById('g-body');
  const mk = monthKey(currentMonth);
  body.innerHTML = S.goals.map(g => {
    const av = calcCatAvailable(g.catId, mk);
    const pct = Math.min((av / g.target) * 100, 100);
    return `
    <div class="goal-card" onclick="openEditGoal('${g.id}')">
      <div class="goal-stripe save"></div>
      <div class="sh-title" style="font-size:18px; margin:0">${g.name}</div>
      <div style="font-size:12px; color:#888; margin-bottom:10px">Meta: ${ef(g.target)}</div>
      <div class="c-prog"><div class="c-prog-fill" style="width:${pct}%"></div></div>
      <div class="goal-sv">${ef(av)}</div>
    </div>`;
  }).join('');
}

// ACTIONS
function setType(t) {
  txType = t;
  document.getElementById('btn-t-exp').style.background = t==='expense'?'#4a6741':'#e6e2d8';
  document.getElementById('btn-t-exp').style.color = t==='expense'?'#fff':'#3a3a36';
  document.getElementById('btn-t-inc').style.background = t==='income'?'#4a6741':'#e6e2d8';
  document.getElementById('btn-t-inc').style.color = t==='income'?'#fff':'#3a3a36';
  document.getElementById('f-cat-fg').style.display = t==='income'?'none':'block';
}

function openSh(id) {
  if(id==='tx') {
    document.getElementById('f-date').value = new Date().toISOString().split('T')[0];
    populateCatSelect('f-cat');
    setType('expense');
  }
  if(id==='goal') { populateCatSelect('g-cat-link'); }
  document.getElementById('ov-'+id).classList.add('open');
}

function closeSh(id) { document.querySelectorAll('.overlay').forEach(o => o.classList.remove('open')); }

function populateCatSelect(elId) {
  const sel = document.getElementById(elId); sel.innerHTML = '';
  S.groups.forEach(g => {
    const optg = document.createElement('optgroup'); optg.label = g.name;
    g.cats.forEach(c => { const o = document.createElement('option'); o.value = c.id; o.textContent = c.name; optg.appendChild(o); });
    sel.appendChild(optg);
  });
}

function saveTx() {
  const tx = {
    id: editingTxId || uid(),
    amt: parseFloat(document.getElementById('f-amt').value),
    pay: document.getElementById('f-pay').value,
    cat: document.getElementById('f-cat').value,
    date: document.getElementById('f-date').value,
    month: document.getElementById('f-date').value.slice(0,7),
    type: txType
  };
  if(editingTxId) S.txs = S.txs.filter(t => t.id !== editingTxId);
  S.txs.push(tx); save(); closeSh(); fullRender();
}

function saveCat() {
  const gName = document.getElementById('c-newg').value || document.getElementById('c-grp').value;
  let group = S.groups.find(g => g.name === gName);
  if(!group) { group = { id:uid(), name:gName, cats:[] }; S.groups.push(group); }
  group.cats.push({ id:uid(), name:document.getElementById('c-nm').value, emoji:document.getElementById('c-emo').value });
  save(); closeSh(); fullRender();
}

function saveGoal() {
  const goal = {
    id: editingGoalId || uid(),
    name: document.getElementById('g-nm').value,
    catId: document.getElementById('g-cat-link').value,
    target: parseFloat(document.getElementById('g-tgt').value),
    date: document.getElementById('g-dt').value
  };
  if(editingGoalId) S.goals = S.goals.filter(g => g.id !== editingGoalId);
  S.goals.push(goal); save(); closeSh(); renderGoals();
}

function openEditGoal(id) {
  const g = S.goals.find(g => g.id === id);
  editingGoalId = id;
  openSh('goal');
  document.getElementById('goal-sh-title').textContent = 'Editar Meta';
  document.getElementById('g-nm').value = g.name;
  document.getElementById('g-tgt').value = g.target;
  document.getElementById('goal-del-btn').style.display = 'block';
}

function deleteGoal() {
  if(confirm('¬øBorrar esta meta?')) { S.goals = S.goals.filter(g => g.id !== editingGoalId); save(); closeSh(); renderGoals(); }
}

function findCat(id) {
  for(let g of S.groups) {
    let c = g.cats.find(c => c.id === id);
    if(c) return { ...c, groupName: g.name };
  }
  return null;
}

function showPanel(id) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('on'));
  document.querySelectorAll('.ntab').forEach(n => n.classList.remove('on'));
  document.getElementById('panel-'+id).classList.add('on');
  document.getElementById('tab-'+id).classList.add('on');
  fullRender();
  if(id==='goals') renderGoals();
}

function chMonth(n) { currentMonth.setMonth(currentMonth.getMonth() + n); fullRender(); }

// INIT
fullRender();
</script>
</body>
</html>
